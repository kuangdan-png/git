<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="../layui/layui.all.js"></script>
    <script src="../layui/layui.js"></script>
    <link rel="stylesheet" href="../layui/css/layui.css">
    <style>
        .moveRight_top li {
            width: 60px;
            height: 60px;
            float: left;
            cursor: pointer;
            margin: 5px;
        }
        .moveRight_top, .moveRight_bottom {
            height: 70px;
            width: 100%;
            background-color: #fafafa;
            box-shadow: 5px 2px 6px #efefef inset;
        }

        .moveRight_top {
            height: 60px;
        }

        .moveRight_top li:hover {
            background-color: #ebebeb;
        }

        .moveRight_bottom {
            margin-top: 2px;
        }

        .moveRight_bottom li {
            float: left;
            cursor: pointer;
            margin-left: 5px;
        }


        .move_left li {
            height: 40px;
            line-height: 40px;
            margin-left: 30px;
        }

        .moveRight_bottom_height {
            height: 38px;
        }

        .moveRight_bottom_height li {
            height: 38px;
            line-height: 38px;
        }

        header {
            width: 100%;
            height: 30px;
            color: white;
            background-color: black;
            line-height: 30px;
        }

        .changeWidth {
            width: 50px;
        }

        .changeWidth2 {
            width: 100px;
        }
        .layui-layer-title{background-color: black;color: white;padding-left: 20px;}
    </style>
</head>
<body>
<header>药品过期查询</header>

<div class="moveRight_bottom moveRight_bottom_height layui-input-inline">
    <form class="layui-form layui-form-pane" action="">
        <ul>
            <li>
                查询还有
                <div class="layui-input-inline"><input id="getMonth" lay-filter="select_filter" name="title" required lay-verify="required"
                                                       class="layui-input changeWidth">
                </div>
                个月到期的药品
            </li>
            <li class="layui-form">
                仓库：
                <div class="layui-input-inline changeWidth2"><select name="orgType" lay-filter="Type_filter"
                                                                     id="wareHoseName" lay-verify="required">
                <option value="" selected>所有仓库</option>
                </select></div>
                <input type="hidden" id="wareHoseName1">
            </li>
            <li>
                商品名称/编号：
                <div class="layui-input-inline"><input type="text" id="proName" name="title"  lay-verify="required"
                                                       class="layui-input ">
                </div>
            </li>
            <li>
                <button type="button" id="search" class="layui-btn layui-btn-radius layui-btn-normal"
                        style="background-color: black;width: 100px;">查询
                </button>
            </li>
            <li>
                <input type="checkbox" id="ku" value="no" checked lay-filter="show">显示库存为零的药品
            </li>
        </ul>
    </form>
</div>

<div>
    <table class="layui-hide dataTable" id="datedTable"></table>
</div>

<script>
    layui.use(['table', 'laydate', 'element','layer','element','form'], function () {
        var laydate = layui.laydate;
        var element = layui.element;
        var $ = layui.$;
        var layer = layui.layer;
        var table = layui.table;
        var form = layui.form;
        //日期范围
        laydate.render({
            elem: '#test6'
            , range: true
        });
        //年月选择器
        laydate.render({
            elem: '#beginTime'
            , type: 'month'
            , value: new Date()
        });

        laydate.render({
            elem: '#endTime'
            , type: 'month'
            , value: new Date()
        });

        laydate.render({
            elem: '#test13'
        });

        // 自动获取仓库的下拉框
        $.ajax({
            url: '/wareHouseManager/searchWareHourseInfo.action',
            dataType: 'json',
            data: {'state': 0},	//查询状态为正常的所有机构类型
            type: 'post',
            success: function (data) {
                var count=0;
                $.each(data, function (index, item) {
                    count++;
                    $('#wareHoseName').append(new Option(item.warName, item.warID));// 下拉菜单里添加元素
                });
                layui.form.render("select");
            }
        });
        $("#getMonth").bind('input propertychange', function () {
            var month = $("#getMonth").val();
            if(isNaN(month)){
                layer.msg('对不起，只能输入数字', {
                    time: 1000, //20s后自动关闭
                    btn: ['好的']
                });
                $("#getMonth").val("");
            }
        });
        var monthValue=$('#getMonth').val();
        var dataValue=$('#wareHoseName').val();
        var proNameVale=$('#proName').val();
        table.render({
            elem: '#datedTable'
            , url: '/wareHouseManager/searchStaleDated.action'
            , cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
            , totalRow: true
            , where: {repProName:dataValue,repComId:proNameVale}
            , cols: [[
                {type:'checkbox'},
                {templet:'<div>{{d.commodity.comId}}</div>', title: '商品编号', width:100,"LAY_CHECKED":true,sort: true}
                ,{templet:'<div>{{d.commodity.comName}}</div>', title: '商品名称', width:110, sort: true}
                ,{templet:'<div>{{d.commodity.comUnit}}</div>', title: '单位', width:80, sort: true}
                ,{templet:'<div>{{d.commodity.comProduct}}</div>', title: '产品规格', width:100, sort: true}
                //,{templet:'<div>{{d.commodity.comQuality}}</div>', title: '有效期至', width:150, sort: true}
                ,{templet: "<div>{{layui.util.toDateString(d.commodity.comQuality, 'yyyy-MM-dd HH:mm:ss')}}</div>",title: '有效期至', width:150, sort: true}
                ,{templet:'<div>{{d.commodity.manufacturer.manName}}</div>', title: '生产厂商', width:150, sort: true}
                , {field: 'repNumber', width: 100, title: '库存数量', sort: true, totalRowText:'总量:', totalRow: true}
                ,{templet:'<div>{{d.warehouse.warName}}</div>', title: '所在仓库', width:100, sort: true}
            ]], response: {
                statusCode: 200 //重新规定成功的状态码为 200，table 组件默认为 0
            }, parseData: function (res) { //将原始数据解析成 table 组件所规定的数据
                return {
                    "code": res.status, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "count": res.count, //解析数据长度
                    "data": res.row//解析数据列表
                };
            }
            , page: true //开启分页
            , limits:[1,5,10,15]
            , height: 480
            , width: 1170
        });
        form.on('checkbox(show)', function(data){
            var monthValue=$('#getMonth').val();
            if(monthValue==null || monthValue==""){
                monthValue=0;
            }
            var wareHoseNo=$('#wareHoseName').val();
            var proNameVale=$('#proName').val();
            var kuNumber=$('#ku').val();
            if(data.elem.checked){
                kuNumber="yes";
            }
            table.reload('datedTable', {
                method: 'post'
                , url: '/wareHouseManager/searchStaleDated.action'
                , where: {
                    repNumber:monthValue,//药品剩余月数
                    repProName:wareHoseNo,//仓库编号
                    repComId:proNameVale,//输入框文本
                    reqWareNo:kuNumber,//是否显示库存为0行
                    // page:1,
                    // limit:10
                }
                , cols: [[
                    {type:'checkbox'},
                    {templet:'<div>{{d.commodity.comId}}</div>', title: '商品编号', width:100,"LAY_CHECKED":true,sort: true}
                    ,{templet:'<div>{{d.commodity.comName}}</div>', title: '商品名称', width:110, sort: true}
                    ,{templet:'<div>{{d.commodity.comUnit}}</div>', title: '单位', width:80, sort: true}
                    ,{templet:'<div>{{d.commodity.comProduct}}</div>', title: '产品规格', width:100, sort: true}
                    //,{templet:'<div>{{d.commodity.comQuality}}</div>', title: '有效期至', width:150, sort: true}
                    ,{templet: "<div>{{layui.util.toDateString(d.commodity.comQuality, 'yyyy-MM-dd HH:mm:ss')}}</div>",title: '有效期至', width:150, sort: true}
                    ,{templet:'<div>{{d.commodity.manufacturer.manName}}</div>', title: '生产厂商', width:150, sort: true}
                    , {field: 'repNumber', width: 100, title: '库存数量', sort: true, totalRowText:'总量:',totalRow: true}
                    ,{templet:'<div>{{d.warehouse.warName}}</div>', title: '所在仓库', width:100, sort: true}
                ]], response: {
                    statusCode: 200 //重新规定成功的状态码为 200，table 组件默认为 0
                }, parseData: function (res) { //将原始数据解析成 table 组件所规定的数据
                    return {
                        "code": res.status, //解析接口状态
                        "msg": res.msg, //解析提示文本
                        "count": res.count, //解析数据长度
                        "data": res.row//解析数据列表
                    };
                }
                , page: true //开启分页
                , limits:[1,5,10,15]
                , height: 450
                , width: 1150
            });
        });
        $('#search').click(function () {
            var monthValue=$('#getMonth').val();
            if(monthValue==null || monthValue==""){
                monthValue=0;
            }
            var wareHoseNo=$('#wareHoseName').val();
            var proNameVale=$('#proName').val();
            var kuNumber=$('#ku').val();
            if($('#ku').prop("checked")==true){
                kuNumber="yes";
            }
            table.reload('datedTable', {
                  method: 'post'
                , url: '/wareHouseManager/searchStaleDated.action'
                , where: {
                    repNumber:monthValue,//药品剩余月数
                    repProName:wareHoseNo,//仓库编号
                    repComId:proNameVale,//输入框文本
                    reqWareNo:kuNumber,//是否显示库存为0行
                  }
                , cols: [[
                    {type:'checkbox'},
                    {templet:'<div>{{d.commodity.comId}}</div>', title: '商品编号', width:100,"LAY_CHECKED":true,sort: true}
                    ,{templet:'<div>{{d.commodity.comName}}</div>', title: '商品名称', width:110, sort: true}
                    ,{templet:'<div>{{d.commodity.comUnit}}</div>', title: '单位', width:80, sort: true}
                    ,{templet:'<div>{{d.commodity.comProduct}}</div>', title: '产品规格', width:100, sort: true}
                    //,{templet:'<div>{{d.commodity.comQuality}}</div>', title: '有效期至', width:150, sort: true}
                    ,{templet: "<div>{{layui.util.toDateString(d.commodity.comQuality, 'yyyy-MM-dd HH:mm:ss')}}</div>",title: '有效期至', width:150, sort: true}
                    ,{templet:'<div>{{d.commodity.manufacturer.manName}}</div>', title: '生产厂商', width:150, sort: true}
                    ,{field: 'repNumber', width: 100, title: '库存数量', sort: true, totalRowText:'总量：', totalRow: true}
                    ,{templet:'<div>{{d.warehouse.warName}}</div>', title: '所在仓库', width:100, sort: true}
                ]], response: {
                    statusCode: 200 //重新规定成功的状态码为 200，table 组件默认为 0
                }, parseData: function (res) { //将原始数据解析成 table 组件所规定的数据
                    return {
                        "code": res.status, //解析接口状态
                        "msg": res.msg, //解析提示文本
                        "count": res.count, //解析数据长度
                        "data": res.row//解析数据列表
                    };
                }
                , page: true //开启分页
                , limits:[1,5,10,15]
                , height: 450
                , width: 1000
            });
        });
        //当点击警包的按钮时
        $('#jinbao').click(function () {
            //获得表格选中的状态
            var checkStatus = table.checkStatus('datedTable');
            //获得表格选中的行数
            var rowsNumber=checkStatus.data.length;
            if(rowsNumber==0){//当没有选择时，弹出提示框
                //配置一个透明的询问框
                layer.msg('请选择要提醒的药品', {
                    time: 5000, //20s后自动关闭
                    btn: ['好的']
                });
            }else if(1>=rowsNumber>0){//当选择后，弹出事件管理
                // 将数据传递给
                console.log(checkStatus.data);
                layer.open({
                    type: 2
                    , title: ['事件提醒管理', 'font-size:13px;', 'background-color:black;']
                    , content:'shijiantixing.html'  //这里content是一个普通的String
                    , btn: ['确定', '取消']
                    , area: ['800px', '500px']
                    , success: function(layero, index){
                        var body = layer.getChildFrame("body");
                        var data ="<input type='hidden' id='data' value=''>"
                        console.log(layero, index);
                    }
                });
            }else{
                //配置一个透明的询问框
                layer.msg('对不起，只能选择一条数据', {
                    time: 5000, //20s后自动关闭
                    btn: ['好的']
                });
            }
        });
    });
</script>
</body>
</html>