<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>采购进货、退货查询</title>
    <link rel="stylesheet" href="layui/css/layui.css" media="all">
    <style>
        #joinproduct{display: none;}
        body .demo-class .layui-layer-title{color:darkslateblue;}
        #body{margin:0 auto;border:1px solid black;width:946px;height: 505px;background-color: whitesmoke;border-radius: 2px 2px 0 0}
        /*头部五个图标*/
        #top_div1{margin:0 auto;margin-top:1px;border: 1px solid #666666;width:942px;height:60px;background-color: #f6fbfb;}
        /*第一个查询*/
        #top_i1,#top_i2,#top_i3,#top_i4,#top_i5{font-size: 30px;}
        .top_span1{font-size: 14px;position: relative;top:-12px;}
        .top_ul1 li div{width:60px;height:53px;margin-left: 30px;position: relative;top:3px;}
        .top_ul1 li div:hover{background: #fff;}
        /*第二个图标*/
        .top_li1{width:60px;height:53px;position: relative;top:-51px;left:130px;}
        .top_ul1 .top_li1:hover{background: #fff;}
        /*第三个图标*/
        .top_li2{width:60px;height:53px;position: relative;top:-105px;left:230px;}
        .top_ul1 .top_li2:hover{background: #fff;}
        /*第四个图标*/
        .top_li3{width:36px;height:53px;position: relative;top:-159px;left:330px;}
        .top_ul1 .top_li3:hover{background: #fff;}
        /*第五个图标*/
        .top_li4{width:36px;height:53px;position: relative;top:-212px;left:420px;}
        .top_ul1 .top_li4:hover{background: #fff;}
        /*中间部分*/
        #center_p1{margin-top:12px;margin-left: 32px;}
        #test19{width:106px;height:20px;margin-top:-29px;margin-left:105px;}
        #center_span1{position: relative;top:-36px;left:225px;}
        #test1{width:106px;height:20px;margin-top:-48px;margin-left:235px;}
        #center_button1{margin-top:-80px;margin-left:30px;}
        #center_div1{margin-top:-40px;background-color: white;}
        /*尾部*/
        #footer_div1{margin-top:-10px;background-color: white;}
    </style>

</head>
<body>
<div id="body">
    <!--头部五个图标-->
    <div id="top_div1">
        <ul class="top_ul1">
            <li>
                <div class="site-demo-button" id="layerDemo1" style="margin-bottom: 0;">
                    <i id="top_i1" data-method="offset" data-type="auto" class="layui-icon layui-icon-search">
                        <br/><span class="top_span1">详细查找</span>
                    </i>
                </div>
            </li>
            <li class="top_li1">
                <i id="top_i2" class="layui-icon layui-icon-search">
                    <br><span class="top_span1">查看单据</span>
                </i>
            </li>
            <li class="top_li2">
                <i id="top_i3" class="layui-icon layui-icon-form">
                    <br><span class="top_span1">整单退货</span>
                </i>
            </li>
            <li class="top_li3">
                <i id="top_i4" class="layui-icon layui-icon-upload-circle">
                    <br><span class="top_span1">导出</span>
                </i>
            </li>
            <li class="top_li4">
                <i id="top_i5" class="layui-icon layui-icon-close-fill">
                    <br><span class="top_span1">退出</span>
                </i>
            </li>
        </ul>
    </div>
    <!--中间部分-->
    <p id="center_p1">查询日期：
    <div class="layui-input-inline">
        <input type="text" class="layui-input" id="test19">
    </div>
    </p>
    <span id="center_span1">至</span>
    <div class="layui-input-inline">
        <input type="text" class="layui-input" id="test1">
    </div>
    <button id="center_button1" type="button" class="layui-btn layui-btn-xs layui-btn-radius">查询(F2)</button>
    <!--中间表格-->
    <div id="center_div1">
        <table class="layui-hide" id="test" lay-filter="test"></table>
    </div>
    <!--尾部-->
    <p>单据的详细信息：</p>
    <div id="footer_div1">
        <table class="layui-hide" id="test2" lay-filter="test"></table>
    </div>
</div>

<script src="layui/layui.js" charset="utf-8"></script>
<script src="layui/layui.all.js"></script>
<script src="JQuery/jquery-3.4.1.min.js"></script>
<script>
    //声明全局变量，保存下表格查询的数据
    var tableData = null;
    //详细查询的弹出框
    /*$('#top_i1').on('click',function () {
        layer.open({
            type: 2
            ,title:'查找'
            ,content:'DetailedSearch.html'
            //,area: ['312px', '305px']
            ,area: ['407px', '445px']
        });
    })*/

    //退出按钮
    $('#top_i5').on('click',function () {
        var index = parent.layer.getFrameIndex(window.name);
        parent.layer.close(index);//关闭当前页
    })

    layui.use(['form', 'layedit', 'laydate'], function() {
        var form = layui.form
            , layer = layui.layer
            , layedit = layui.layedit
            , laydate = layui.laydate;

        //日期
        laydate.render({
            elem: '#date'
        });
        //初始赋值
        laydate.render({
            elem: '#test19'
            ,value: '2019-10-25'
            ,isInitValue: true
        });
        laydate.render({
            elem: '#test1'
            ,value:'2019-11-25'
            ,isInitValue: true
        });
    });

    //获得父类传递的数据
    var no = parent.PartitionId;
    var num=no.indexOf(",");
    var wareHourseNo=no.substring(0,num);
    var supplierNo=no.substring(num+1);
    //查询所有的单据
    layui.use('table', function(){
        var table = layui.table;
        table.render({
            elem: '#test'
            ,url:'/GoodsReturnSearch/StockAndGoodsReturnSearch.action'
            ,where:{"recWareNo": wareHourseNo,"recRemark":supplierNo}
            ,height:170
            ,page:true
            ,limits:[1,5,10,15]
            ,cols: [[
                {templet:'<div>{{d.receipts.recOdd}}</div>', title: '单号',width:200,align: 'center'}
                ,{templet:'<div>{{d.receipts.recDate}}</div>', title: '开单日期',width:200,align: 'center'} //width 支持：数字、百分比和不填写。你还可以通过 minWidth 参数局部定义当前单元格的最小宽度，layui 2.2.1 新增
                ,{templet:'<div>{{d.receipts.warehouse.warName}}</div>', title: '仓库名称',width:150,align: 'center'}
                ,{templet:'<div>{{d.receipts.receiptstype.retName}}</div>', title: '单据类型',width:100,align: 'center'}
                ,{templet:'<div>{{d.receipts.employees.empName}}</div>', title: '经办人',width:100,align: 'center'}
                ,{templet:'<div>{{d.receipts.recRemark}}</div>', title: '备注',width:150,align: 'center'}
            ]]
            ,parseData: function (res, curr, count) { //res 即为原始返回的数据 //curr得到当前页码//count得到数据总量
                return {
                    "code": res.status, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "count": res.count, //解析数据长度
                    "data": res.row //解析数据列表
                };
            },done:function (obj) {
                layer.closeAll();
            }
        });

        //根据时间范围查询单据
        $('#center_button1').click(function(){
            var startTime = $('#test19').val();
            var endTime = $('#test1').val();
            //alert(startTime+" "+endTime);
            table.render({
                elem: '#test'
                ,url:'/GoodsReturnSearch/StockAndGoodsReturnSearch.action'
                ,where:{startTime:startTime,endTime:endTime}
                ,height:170
                ,page:true
                ,limits:[1,5,10,15]
                ,cols: [[
                    {templet:'<div>{{d.receipts.recOdd}}</div>', title: '单号',width:200,align: 'center'}
                    ,{templet:'<div>{{d.receipts.recDate}}</div>', title: '开单日期',width:200,align: 'center'} //width 支持：数字、百分比和不填写。你还可以通过 minWidth 参数局部定义当前单元格的最小宽度，layui 2.2.1 新增
                    ,{templet:'<div>{{d.receipts.warehouse.warName}}</div>', title: '仓库名称',width:150,align: 'center'}
                    ,{templet:'<div>{{d.receipts.receiptstype.retName}}</div>', title: '单据类型',width:100,align: 'center'}
                    ,{templet:'<div>{{d.receipts.employees.empName}}</div>', title: '经办人',width:100,align: 'center'}
                    ,{templet:'<div>{{d.receipts.recRemark}}</div>', title: '备注',width:150,align: 'center'}
                ]]
                ,parseData: function (res, curr, count) { //res 即为原始返回的数据 //curr得到当前页码//count得到数据总量
                    return {
                        "code": res.status, //解析接口状态
                        "msg": res.msg, //解析提示文本
                        "count": res.count, //解析数据长度
                        "data": res.row //解析数据列表
                    };
                },done:function (obj) {
                    layer.closeAll();
                }
            });
        })
        //第一次查询单据的详细信息（无数据）
        layui.use('table', function(){
            var table = layui.table;
            table.render({
                elem: '#test2'
                ,url:'/GoodsReturnSearch/SearchReceiptsInfo.action'
                ,totalRow: true
                ,height:195
                ,cols: [[
                    {field: 'redProcutsNo', title: '商品编号', width: 120, align: 'center', totalRowText: '品种合计'}
                    , {field: 'redName', title: '商品名称', width: 150, align: 'center'}
                    , {field: 'redUnit', title: '单位', width: 80, align: 'center'}
                    ,{field:'redPrice', title: '单价',width:80,align: 'center'}
                    ,{field:'redCount', title: '数量',width:80,align: 'center',totalRow: true}
                    ,{field:'redTotalPrice', title: '总金额',width:100,align: 'center',totalRow: true,templet:function(d){
                        return d.redPrice * d.redCount;
                        }} //单元格内容水平居中
                    ,{field:'redredduct', title: '产品规格', width:100,align: 'center'} //单元格内容水平居中
                    ,{field:'score', title: '产品批次', width:100,align: 'center'}
                    ,{field:'redValidUntil',templet:'<div>{{ layui.util.toDateString(d.redValidUntil,"yyyy-MM-dd HH:mm:ss")}}</div>', title: '有效期至', width:160,align: 'center'}
                ]]
                ,parseData: function (res, curr, count) { //res 即为原始返回的数据 //curr得到当前页码//count得到数据总量
                    return {
                        "code": res.status, //解析接口状态
                        "msg": res.msg, //解析提示文本
                        "count": res.count, //解析数据长度
                        "data": res.row //解析数据列表
                    };
                }
            });
        });
        //第二次根据获取的上面表格的单号查询单据的详细信息
        //监听行单击事件（双击事件为：rowDouble）
        layui.use('table', function() {
            var table = layui.table;
            table.on('row(test)', function (obj) {
                console.log(obj);
                var recOdd = obj.data.receipts.recNo;
                table.render({
                    elem: '#test2'
                    , url: '/GoodsReturnSearch/SearchReceiptsInfobyRecNo.action'
                    , where: {recOdd: recOdd}
                    , totalRow: true
                    , height: 195
                    , cols: [[
                         {field: 'redProcutsNo', title: '商品编号', width: 120, align: 'center', totalRowText: '品种合计'}
                        , {field: 'redName', title: '商品名称', width: 150, align: 'center'}
                        , {field: 'redUnit', title: '单位', width: 80, align: 'center'}
                        , {field: 'redPrice', title: '单价', width: 80, align: 'center'}
                        , {field: 'redCount', title: '数量', width: 80, align: 'center', totalRow: true}
                        , {field: 'duo', title: '总金额', width: 100, align: 'center', totalRow: true,templet: function (d) {
                                return Number(d.redPrice)*Number(d.redCount);
                          }}
                        , {field: 'redredduct', title: '产品规格', width: 100, align: 'center'} //单元格内容水平居中
                        , {field: 'score', title: '产品批次', width: 100, align: 'center'}
                        , {
                            field: 'redValidUntil',
                            templet: '<div>{{ layui.util.toDateString(d.redValidUntil,"yyyy-MM-dd HH:mm:ss")}}</div>',
                            title: '有效期至',
                            width: 160,
                            align: 'center'
                        }
                    ]]
                    , parseData: function (res, curr, count) { //res 即为原始返回的数据 //curr得到当前页码//count得到数据总量
                        return {
                            "code": res.status, //解析接口状态
                            "msg": res.msg, //解析提示文本
                            "count": res.count, //解析数据长度
                            "data": res.row //解析数据列表
                        };
                    }
                    ,done:function (obj) {
                        layer.closeAll();
                        var onwanceTotal=0;//统计结算后余额
                        layui.each(obj.data,function(index,d){
                            onwanceTotal+=Number(d.redPrice)*Number(d.redCount)
                        })
                        //修改 结算后余额 统计单元格文本
                        this.elem.next().find('.layui-table-total td[data-field="duo"] .layui-table-cell').text(onwanceTotal)
                    }
                });
                //使用 layui.table.cache.tablename 可以取到表格中所有数据
                $('#top_i3').on('click',function () {
                    parent.StockGoods(recOdd,tableData);
                    //alert(recOdd);
                    //关闭当前弹窗
                    var index = parent.layer.getFrameIndex(window.name);
                    parent.layer.close(index);
                })
            });
        })
    });

</script>
</body>
</html>