<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="warehouse.crud">
    <!--
        查询仓库中的过期药品
    -->
    <select id="searchStaleDated" resultMap="repertorySonMap" parameterType="repertorySon">
        select comId,repId,manId,comName,warID,comUnit,comProduct,comApproval,manName,repertoryson.repNumber,warName
        from commodity
        inner join manufacturer on comManufact=manId
        inner join repertoryson on repComId=comId
        inner join warehouse on reqWareNo=warID
        where 1=1
        <if test="repNumber != null and repNumber !='' and repNumber !=0">
            and (timestampdiff(second ,now(),timestampdiff(month,comStarTime,comEndTime))/60/60/24/30) &gt; (#{repNumber}-1)
            and (timestampdiff(second ,now(),timestampdiff(month,comStarTime,comEndTime))/60/60/24/30) &lt;= #{repNumber}
        </if>
        <if test="repProName !=null and repProName != ''">
            and warID=#{repProName}
        </if>
        <if test="repComId !='' and repComId !=null ">
            and (comName like concat('%',#{repComId},'%')
            or comId like concat('%',#{repComId},'%'))
            or comId=#{repComId}
        </if>
        <if test="reqWareNo!='' and reqWareNo != null and reqWareNo == 'yes'">
            and repertoryson.repNumber &gt;= 0
        </if>
        <if test="reqWareNo!='' and reqWareNo != null and reqWareNo == 'no'">
            and repertoryson.repNumber &gt; 0
        </if>
        limit #{page},#{limit}
    </select>
    <!--
        查询仓库中的过期药品的数量
    -->
    <select id="searchTotalRows" resultType="int" parameterType="repertorySon">
        select count(*) from commodity
        inner join manufacturer on comManufact=manId
        inner join repertoryson on repComId=comId
        inner join warehouse on reqWareNo=warID
        where 1=1
        <if test="repNumber != null and repNumber !='' and repNumber !=0">
            and (timestampdiff(second ,now(),timestampdiff(month,comStarTime,comEndTime))/60/60/24/30)  &gt; (#{repNumber}-1)
            and (timestampdiff(second ,now(),timestampdiff(month,comStarTime,comEndTime))/60/60/24/30)  &lt;= #{repNumber}
        </if>
        <if test="repProName !=null and repProName != ''">
            and warID=#{repProName}
        </if>
        <if test="repComId !='' and repComId !=null ">
            and (comName like concat('%',#{repComId},'%')
            or comId like concat('%',#{repComId},'%'))
        </if>
        <if test="reqWareNo!='' and reqWareNo != null and reqWareNo == 'yes'">
            and repertoryson.repNumber &gt;= 0
        </if>
        <if test="reqWareNo!='' and reqWareNo != null and reqWareNo == 'no'">
            and repertoryson.repNumber &gt; 0
        </if>
    </select>
    <!--
        查询 库存数量 低于 最低库存 的药品
    -->
    <select id="searchWarehouseNumIsZero" resultMap="commodityAnotherMap">
        select comId,repId,manId,comName,warID,comUnit,
        comProduct,comApproval,manName,
        repertoryson.repNumber,warName,comPrice
        from commodity
        inner join manufacturer on comManufact=manId
        inner join repertoryson on repComId=comId
        inner join warehouse on reqWareNo=warID
        where repertoryson.repNumber &lt;= repertoryson.reqLowest
        limit #{page},#{limit}
    </select>
    <!--
        查询 库存数量 低于 最低库存 的药品数量
    -->
    <select id="searchWarehouseNumIsZeroTotalRows" resultType="int">
        select COUNT(*) from commodity
        inner join manufacturer on comManufact=manId
        inner join repertoryson on repComId=comId
        inner join warehouse on reqWareNo = warID
        where repertoryson.repNumber &lt;= repertoryson.reqLowest
    </select>
    <!--
        查询药品进货、销售明细的数量
    -->
    <select id="searchPurchaseAndSalesDetailsTotalRows" resultType="int">
        select COUNT(*) from receipts r
        inner join receipts_detailed rs on r.recNo = rs.redRecNo
        inner join employees e on r.recEmployeeNo = e.empNo
        inner join receiptstype rt on rs.redDocumentTypes = rt.retNo
        inner join warehouse w on w.warID = r.recWareNo
        where redProcutsNo = #{redProcutsNo}
        and recDate between #{duo1} and #{duo2}
    </select>

    <!--
        查询药品进货、销售明细
    -->
    <select id="searchPurchaseAndSalesDetails" resultMap="receiptsMap">
        select * from receipts r
        inner join receipts_detailed rs on r.recNo = rs.redRecNo
        inner join employees e on r.recEmployeeNo = e.empNo
        inner join receiptstype rt on rs.redDocumentTypes = rt.retNo
        inner join warehouse w on w.warID = r.recWareNo
        where redProcutsNo = #{redProcutsNo}
        and recDate between #{duo1} and #{duo2}
        limit #{page},#{limit}
    </select>
    <resultMap id="maxNoMap" type="maxNo">
        <id column="manID" property="manID"/>
        <result column="manName" property="manName"/>
        <result column="manSort" property="manSort"/>
        <result column="manRemark" property="manRemark"/>
        <result column="manQu" property="manQu"/>
        <result column="manPre" property="manPre"/>
        <result column="manSt" property="manSt"/>
    </resultMap>

    <!--库存明细表的map-->
    <resultMap id="repertorySonMap" type="repertorySon">
        <id column="repId" property="repId"/>
        <result column="repComId" property="repComId"/>
        <result column="repProName" property="repProName"/>
        <result column="repNumber" property="repNumber"/>
        <result column="reqTotality" property="reqTotality"/>
        <result column="reqPrice" property="reqPrice"/>
        <result column="reqShouPrice" property="reqShouPrice"/>
        <result column="reqCurrent" property="reqCurrent"/>
        <result column="reqLowest" property="reqLowest"/>
        <result column="reqWareNo" property="reqWareNo"/>
        <result column="duo1" property="duo1"/>
        <result column="duo2" property="duo2"/>
        <result column="duo3" property="duo3"/>
        <result column="duo4" property="duo4"/>
        <result column="duo5" property="duo5"/>
        <association property="warehouse" resultMap="warehouseMap"/>
        <association property="commodity" resultMap="commodityMap"/>
    </resultMap>


    <!--库存map-->
    <resultMap id="warehouseMap" type="warehouse">
        <id column="warID" property="warID"/>
        <result column="warName" property="warName"/>
        <result column="employeesNo" property="employeesNo"/>
        <result column="warPhone" property="warPhone"/>
        <result column="warAddressNo" property="warAddressNo"/>
        <result column="warAddress" property="warAddress"/>
        <result column="warDefault" property="warDefault"/>
        <result column="warForbidNo" property="warForbidNo"/>
        <result column="warComment" property="warComment"/>
        <result column="repNumber" property="repNumber"/>
        <result column="warTotalValue" property="warTotalValue"/>
        <result column="warCurrent" property="warCurrent"/>
        <result column="warLowest" property="warLowest"/>
        <result column="duo1" property="duo1"/>
        <result column="duo2" property="duo2"/>
        <result column="duo3" property="duo3"/>
    </resultMap>

    <!--商品的map-->
    <resultMap id="commodityMap" type="commodity">
        <id column="comId" property="comId"/>
        <result column="comName" property="comName"/>
        <result column="comSimpleCode" property="comSimpleCode"/>
        <result column="comTypeId" property="comTypeId"/>
        <result column="comGenericName" property="comGenericName"/>
        <result column="comBarCode" property="comBarCode"/>
        <result column="comUnit" property="comUnit"/>
        <result column="comEpherine" property="comEpherine"/>
        <result column="comElectonic" property="comElectonic"/>
        <result column="comProduct" property="comProduct"/>
        <result column="comMedicame" property="comMedicame"/>
        <result column="comRegister" property="comRegister"/>
        <result column="comApproval" property="comApproval"/>
        <!--<result column="comQuality" property="comQuality"/>-->
        <result column="comState" property="comState"/>
        <result column="comSpecial" property="comSpecial"/>
        <result column="comPurchase" property="comPurchase"/>
        <result column="comPrice" property="comPrice"/>
        <result column="comManufact" property="comManufact"/>
        <result column="comRemarks" property="comRemarks"/>
        <result column="comMinKuNumber" property="comMinKuNumber"/>
        <result column="duo1" property="duo1"/>
        <result column="duo2" property="duo2"/>
        <result column="duo4" property="duo4"/>
        <result column="duo5" property="duo5"/>
        <association property="manufacturer" resultMap="manufacturerMap"/>
    </resultMap>
    <!--生产厂商map-->
    <resultMap id="manufacturerMap" type="manufacturer">
        <id column="manId" property="manId"/>
        <result column="manName" property="manName"/>
        <result column="manTelPhe" property="manTelPhe"/>
        <result column="manAddressNo" property="manAddressNo"/>
        <result column="manAddress" property="manAddress"/>
        <result column="manEmail" property="manEmail"/>
        <result column="manRemarks" property="manRemarks"/>
        <result column="duo1" property="duo1"/>
        <result column="duo2" property="duo2"/>
    </resultMap>

    <!--单据表map-->
    <resultMap id="receiptsMap" type="receipts">
        <id column="recNo" property="recNo"/>
        <result column="recOdd" property="recOdd"/>
        <result column="recDocumentTypes" property="recDocumentTypes"/>
        <result column="recEmployeeNo" property="recEmployeeNo"/>
        <result column="recRemark" property="recRemark"/>
        <result column="recWareNo" property="recWareNo"/>
        <result column="recTiaoNumber" property="recTiaoNumber"/>
        <result column="recTotalNumber" property="recTotalNumber"/>
        <result column="redDepotNo" property="redDepotNo"/>
        <result column="redFatherNo" property="redFatherNo"/>
        <result column="duo1" property="duo1"/>
        <association property="receiptsDetailed" resultMap="receiptsDetailedMap"/>
        <association property="employees" resultMap="employeesMap"/>
        <association property="warehouse" resultMap="warehouseMap"/>
        <association property="receiptstype" resultMap="receiptstypeMap"/>
    </resultMap>

    <!--单据明细表map-->
    <resultMap id="receiptsDetailedMap" type="receiptsDetailed">
        <id column="redNo" property="redNo"/>
        <result column="redOdd" property="redOdd"/>
        <result column="redProcutsNo" property="redProcutsNo"/>
        <result column="redName" property="redName"/>
        <result column="redredduct" property="redredduct"/>
        <result column="redPermitNo" property="redPermitNo"/>
        <result column="redDate" property="redDate"/>
        <result column="redValidUntil" property="redValidUntil"/>
        <result column="redPriceredCount" property="redPriceredCount"/>
        <result column="redManufact" property="redManufact"/>
        <result column="redManufactName" property="redManufactName"/>
        <result column="redPreprice" property="redPreprice"/>
        <result column="redTotalPrice" property="redTotalPrice"/>
        <result column="redSupplierNo" property="redSupplierNo"/>
        <result column="redPutNo" property="redPutNo"/>
        <result column="redDepotNo" property="redDepotNo"/>
        <result column="redredchaseDate" property="redredchaseDate"/>
        <result column="redComment" property="redComment"/>
        <result column="redReturnDate" property="redReturnDate"/>
        <result column="redProductTypeNo" property="redProductTypeNo"/>
        <result column="redDocumentTypes" property="redDocumentTypes"/>
        <result column="redProductTypeName" property="redProductTypeName"/>
        <result column="redRecNo" property="redRecNo"/>
        <result column="redZhe" property="redZhe"/>
        <result column="redModel" property="redModel"/>
        <result column="redQuanStock" property="redQuanStock"/>
        <result column="redCountedQuantity" property="redCountedQuantity"/>
        <result column="duo1" property="duo1"/>
        <result column="duo2" property="duo2"/>
        <result column="duo3" property="duo3"/>
        <result column="duo4" property="duo4"/>
        <result column="duo5" property="duo5"/>
        <result column="duo6" property="duo6"/>
        <result column="duo7" property="duo7"/>
    </resultMap>
    <!--员工信息map-->
    <resultMap id="employeesMap" type="employees">
        <id column="empNo" property="empNo"/>
        <result column="empName" property="empName"/>
    </resultMap>
    <!--进销类型map-->
    <resultMap id="receiptstypeMap" type="receiptstype">
        <id column="retNo" property="retNo"/>
        <result column="retNo" property="retNo"/>
        <result column="retName" property="retName"/>
        <result column="retSort" property="retSort"/>
        <result column="retRemark" property="retRemark"/>
    </resultMap>

    <resultMap id="commodityAnotherMap" type="commodity">
        <id column="comId" property="comId"/>
        <result column="comName" property="comName"/>
        <result column="comSimpleCode" property="comSimpleCode"/>
        <result column="comTypeId" property="comTypeId"/>
        <result column="comGenericName" property="comGenericName"/>
        <result column="comBarCode" property="comBarCode"/>
        <result column="comUnit" property="comUnit"/>
        <result column="comEpherine" property="comEpherine"/>
        <result column="comElectonic" property="comElectonic"/>
        <result column="comProduct" property="comProduct"/>
        <result column="comMedicame" property="comMedicame"/>
        <result column="comRegister" property="comRegister"/>
        <result column="comApproval" property="comApproval"/>
        <!--<result column="comQuality" property="comQuality"/>-->
        <result column="comState" property="comState"/>
        <result column="comSpecial" property="comSpecial"/>
        <result column="comPurchase" property="comPurchase"/>
        <result column="comPrice" property="comPrice"/>
        <result column="comManufact" property="comManufact"/>
        <result column="comRemarks" property="comRemarks"/>
        <result column="comMinKuNumber" property="comMinKuNumber"/>
        <association property="manufacturer" resultMap="manufacturerMap"/>
        <association property="warehouse" resultMap="warehouseMap"/>
        <association property="repertorySon" resultMap="repertorySonAnotherMap"/>
    </resultMap>

    <resultMap id="repertorySonAnotherMap" type="repertorySon">
        <id column="repId" property="repId"/>
        <result column="repComId" property="repComId"/>
        <result column="repProName" property="repProName"/>
        <result column="repNumber" property="repNumber"/>
        <result column="reqTotality" property="reqTotality"/>
        <result column="reqPrice" property="reqPrice"/>
        <result column="reqShouPrice" property="reqShouPrice"/>
        <result column="reqCurrent" property="reqCurrent"/>
        <result column="reqLowest" property="reqLowest"/>
        <result column="reqWareNo" property="reqWareNo"/>
        <result column="duo1" property="duo1"/>
        <result column="duo2" property="duo2"/>
        <result column="duo3" property="duo3"/>
        <result column="duo4" property="duo4"/>
        <result column="duo5" property="duo5"/>
    </resultMap>

    <!--仓库信息查询（单表）-->
    <select id="searchWareHourseInfo" resultMap="warehouseMap">
      select warID,warName,employeesNo,warPhone,warAddressNo,warAddress,warDefault,warForbidNo,
      warComment,repNumber,warTotalValue,warCurrent,warLowest,duo1,duo2,duo3 from warehouse where
      warForbidNo=0
   </select>
    <!--查询最大编号-->
    <select id="searchMaxNo" resultMap="maxNoMap" parameterType="maxNo">
        select manID,manName,manSort,manRemark,manQu,manPre,manSt from max_no where
        1=1
        <if test="manQu!=null">
            and manQu=#{manQu}
        </if>
         <if test="manName != null and manName !=''">
            and manName=#{manName}
         </if>

    </select>
</mapper>