<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>会员管理</title>

    <link rel="stylesheet" href="layui/css/layui.css">
    <script src="layui/layui.js"></script>
    <script src="layui/layui.all.js"></script>
    <script src="JQuery/jquery-3.4.1.min.js"></script>
    <script src="layui/lay/modules/laydate.js"></script>
</head>
<body>

<div class="layui-tab layui-tab-card">
    <ul class="layui-tab-title">
        <li class="layui-this">会员管理</li>
    </ul>
    <div class="layui-tab-content">
        <!--1会员管理-->
        <div class="layui-tab-item layui-show">
            <!--1-1头部按钮-->
            <div id="button" style="display: none">
                <button id="insert" lay-event="add" type="button" class="layui-icon layui-icon-add-1" style="width: 25px;height: 25px;border: 1px solid #a5a5a5;background:rgba(242,242,242,0.1);margin-left: 5px;"></button>
                <button id="update" lay-event="update" type="button" class="layui-icon layui-icon-edit" style="width: 25px;height: 25px;border: 1px solid #a5a5a5;background:rgba(242,242,242,0.1);margin-left: 5px;"></button>
                <button id="delete" lay-event="delete" type="button"  class="layui-icon layui-icon-close" style="width: 25px;height: 25px;border: 1px solid #a5a5a5;background:rgba(242,242,242,0.1);margin-left: 5px;"></button>
                <button id="select" lay-event="select" type="button" class="layui-icon layui-icon-search" style="width: 25px;height: 25px;border: 1px solid #a5a5a5;background:rgba(242,242,242,0.1);margin-left: 5px;"></button>
            </div>
            <!--会员管理表-->
            <table class="layui-hide" id="demo" lay-filter="test"></table>
        </div>
    </div>
</div>
<div id="importe" style="height: 30px;display: inline-block;line-height:30px;position: absolute;top:121px;left:822px;background-color: rgba(0,0,0,0.5);padding-top: 15px;color: white">
    <form style="display:none"
          id="secondform">
        <input type="file" value="上传文件" name="file">
        <botton type="botton" id="secondsum"
                style="background-color: rgba(0,0,0,0.8);
                display:inline-block;color: white;padding-left: 5px;padding-right: 5px">开始上传</botton>
    </form></div>


<!--弹出框-新增会员-->
<div id="insertdiv" style="display: none">
    <form id="finsert" method="post" autocomplete="off" action="" class="layui-form">
        <table align="center" cellpadding="3px">
            <tr>
                <td>会员编号:</td>
                <td>
                    <input type="text" name="memNo" id="maxId" lay-verify="required" class="layui-input"  title="禁用" disabled="">
                </td>
            </tr>

            <tr>
                <td>会员名称:</td>
                <td><input type="text" name="memName" id="idName" lay-verify="required" class="layui-input"></td>
            </tr>

            <tr>
                <td>会员级别:</td>
                <td>
                    <select name="memGrade" id="memGrade" lay-ignore class="province-selector" style="width: 100%;height:40px;">
                        <option value="普通会员" >普通会员</option>
                        <option value="中级会员" >中级会员</option>
                        <option value="高级会员" >高级会员</option>
                        <option value="无卡会员" >无卡会员</option>
                    </select>
                </td>
            </tr>

            <tr>
                <td>优惠方式:</td>
                <td>
                    <select name="memPreferential" id="memPreferential" lay-ignore class="province-selector" style="width: 100%;height:40px;">
                        <option value="无优惠" >无优惠</option>
                    </select>
                </td>
            </tr>

            <tr>
                <td>会员积分:</td>
                <td><input type="text" name="memIntegral" id="idInte" lay-verify="required" value="500" class="layui-input"></td>
            </tr>
            <tr>
                <td>联系电话:</td>
                <td><input type="text" name="memPhone" id="idPhone" lay-verify="required" class="layui-input"></td>
            </tr>
            <tr>
                <td>加入日期:</td>
                <td><input type="text" name="memJoinDateStr" lay-verify="required" class="layui-input" id="date1"></td>
            </tr>

            <tr>
                <td>截止日期:</td>
                <td><input type="text" name="memExpireDateStr"  lay-verify="required"  class="layui-input" id="date2"></td>
            </tr>

            <tr>
                <td>备注:</td>
                <td><input type="text" name="memRemark" id="idRemark" lay-verify="required" class="layui-input"></td>
            </tr>
            <tr>
                <td>
                    <button lay-submit lay-filter="okAdd" id="LAY-component-form-getval"
                            class="layui-btn layui-btn-sm layui-btn-radius">提交
                    </button>
                </td>
                <td>
                    <button type="reset" class="layui-btn layui-btn-sm layui-btn-radius">重置</button>
                </td>
            </tr>
        </table>
    </form>
</div>



<!--弹出一个查询框架-->
<div id="selectdiv" style="display: none">
    <form id="fselect" method="post" autocomplete="off" action="">
        <table align="center" cellpadding="3px">
            <tr>
                <td>要查询的会员名称:</td>
                <td><input type="text" id="memName" name="memName" lay-verify="required" class="layui-input">  </td>
                <td>
                    <button type="button" id="selectMember" class="layui-btn">搜索</button>
                </td>
            </tr>

        </table>
    </form>
</div>




<script>
    $(function(){
        $(".layui-tab-content").dblclick(function(){
            $("#secondform").css({"display": " none"});
        })
    })

    layui.use(['table','laydate'], function(){
        var laydate = layui.laydate;
        var table = layui.table;

        //执行一个laydate实例
        laydate.render({
            elem: '#date1' //指定元素
            ,value:new Date()
            ,type:'datetime'
            ,format:'yyyy-MM-dd HH:mm:ss'
        });
        //执行一个laydate实例
        laydate.render({
            elem: '#date2' //指定元素
            ,value:new Date()
            ,type:'datetime'
            ,format:'yyyy-MM-dd HH:mm:ss'
        });
    });

    // 日期转换
    function createTime(v){
        var date=new Date(v)
        var y=date.getFullYear();
        var m=date.getMonth()+1;
        m=m<10?'0'+m:m;
        var d=date.getDate();
        d=d<10?("0"+d):d;
        var h=date.getHours();
        h=h<10?("0"+h):h;
        var M=date.getMinutes();
        M=m<10?("0"+M):M;
        var str=y+"-"+m+"-"+d+" "+h+":"+M;
        return str;
    }


    //执行一个 table 实例 查询会员信息
    layui.use(['table','element','form'], function() {
        var table = layui.table;
        var element = layui.element;
        var form = layui.form;
        var layer = layui.layer;
        $ = layui.jquery;
        //第一个实例
        table.render({
            elem: '#demo'
            , id: 'memTable'
            , url: '/member/searchMembersInter.action'
            , page: true //开启分页
            , limits: [5, 10, 15]//分页的页数
            , toolbar: '#button' //开启工具栏，此处显示默认图标，可以自定义模板，详见文档
            , totalRow: true //开启合计行
            , height:440
            ,defaultToolbar: ['filter', 'print', 'exports', {
                title: '导入' //标题
                ,layEvent: 'upload' //事件名，用于 toolbar 事件中使用
                ,icon: 'layui-icon-upload-circle' //图标类名

            }]
            , cols: [[ //表头
                {type: 'checkbox', fixed: 'left'}
                , {field: 'memNo', title: '会员编号'}
                , {field: 'memName', title: '会员名称'}
                , {field: 'memGrade', title: '会员级别'}
                , {field: 'memPreferential', title: '优惠方式'}
                , {field: 'memIntegral', title: '会员积分'}
                , {field: 'memPhone', title: '联系电话'}
                , {
                    field: 'memJoinDate', title: '入职日期', width: 150,
                    templet: function (row) {
                        return createTime(row.memJoinDate)
                    }
                }
                , {
                    field: 'memExpireDate', title: '截止日期', width: 150,
                    templet: function (row) {
                        return createTime(row.memExpireDate)
                    }
                }
            ]], response: {
                statusCode: 200 //重新规定成功的状态码为 200，table 组件默认为 0
            }, parseData: function (res) { //将原始数据解析成 table 组件所规定的数据
                return {
                    "code": res.status, //解析接口状态
                    "count": res.count, //解析数据长度
                    "data": res.row//解析数据列表
                };
            }
            , done: function (res, curr, count) {
                currNum = curr;    //得到当前页码
            }
        });


        table.on('toolbar(test)', function (obj) {
            var checkStatus = table.checkStatus(obj.config.id)
                , data = checkStatus.data; //获取选中的数据
            var that = this;

            switch (obj.event) {
                case 'add'://新增
                    $.ajax({//最大编号
                        type: "post",
                        url: '/member/selectMembersId.action',//
                        data: '',
                        success: function (result) {
                            $("#maxId").attr("value", result);
                        }
                    });
                    layer.open({
                        //layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                        type: 1,//类型样式
                        closeBtn: 1,
                        title: "新增员工信息",//标题
                        area: ['30%', '93%'],//弹出框大小
                        content: $('#insertdiv'),//弹出的表单
                        skin: 'demo-class',
                        success: function (layero, index) {
                            $('#insertdiv').css({"display": "block"});
                            //新增提交 监听表单提价按钮
                            form.on('submit(okAdd)', function (data) {
                                $.ajax({
                                    url: "/member/insertMembers.action",
                                    type: 'post',
                                    data: data.field,
                                    dataType: 'JSON',
                                    success: function (data) {
                                        if (data == "successed") {
                                            // 新增成功刷新页面
                                            layer.close(index);
                                            table.reload("memTable");
                                        }
                                    }
                                })
                            });
                        },
                        //结束时隐藏弹出框
                        end: function (layero, index) {
                            $('#insertdiv').css({"display": "none"});
                            // 结束时清空表单内容
                            $("#finsert")[0].reset();
                            layui.form.render();
                        }
                    });

                    break;
                case 'update'://编辑会员信息
                    // 判断是否选中数据
                    if (data.length === 0) {
                        layer.msg('请选择一行');
                    } else if (data.length > 1) {
                        layer.msg('只能同时编辑一个');
                    } else {
                        // 获取选中行的数据

                        var isCheckStatus=checkStatus.data[0].memNo;
                        $("#maxId").val(isCheckStatus);
                        $("#idInte").val(checkStatus.data[0].memIntegral);
                        $("#idPhone").val(checkStatus.data[0].memPhone);
                        $("#idName").val(checkStatus.data[0].memName);
                        $("#memGrade").val(checkStatus.data[0].memGrade);
                        $("#idRemark").val(checkStatus.data[0].memRemark);
                        $("#memPreferential").val(checkStatus.data[0].memPreferential);

                        $("#date1").attr("value", checkStatus.memJoinDate);
                        $("#date2").attr("value", checkStatus.memExpireDate);
                        layer.open({
                            //layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                            type: 1,
                            closeBtn: 1,
                            title: "修改员工信息",
                            area: ['30%', '93%'],//弹出框大小
                            content: $('#insertdiv'),
                            skin: 'demo-class',
                            success: function (layero, index) {
                                $('#insertdiv').css({"display": "block"});
                                //新增提交 监听表单提价按钮
                                form.on('submit(okAdd)', function (data) {
                                    $.ajax({
                                        url: "/member/updateMembers.action",
                                        type: 'post',
                                        data: data.field,
                                        dataType: 'JSON',
                                        success: function (data) {
                                            if (0 != data) {
                                                // 修改成功刷新
                                                layer.close(index);
                                                table.reload("memTable");

                                            }
                                        }
                                    })
                                });
                            },
                            //结束时隐藏弹出框
                            end: function (layero, index) {
                                $('#insertdiv').css({"display": "none"});
                                // 结束时清空表单内容
                                $("#finsert")[0].reset();
                                layui.form.render();
                            }
                        });
                    }
                    break;
                case 'delete'://删除会员信息
                    // 判断是否选中要删除的数据
                    if (data.length === 0) {
                        layer.msg('请选择一行');
                    } else {

                        layer.confirm("确认要删除吗？", function (index) {
                            var isCherckred = checkStatus.data;//获取选中的编号，可以选中多行数据
                            var memNoStr = "";
                            for (var i = 0; i < isCherckred.length; i++) {
                                var memNo = isCherckred[i].memNo;
                                memNoStr += memNo;
                                if (i != isCherckred.length - 1) {
                                    memNoStr += ",";
                                }
                            }
                            $.ajax({
                                type: "post",
                                url: '/member/deleteMembers.action',
                                data: 'memNo=' + memNoStr,//根据编号删除的条件
                                dataType: "text",
                                success: function (data) {
                                    if (data == "successed") {
                                        // 删除成功刷新
                                        layer.close(index);
                                        table.reload("memTable");
                                    } else {
                                        layer.msg('删除失败');
                                    }
                                }
                            });
                        });
                    }
                    break;
                //按会员名称进行搜索
                case 'select':
                    layer.open({
                        //layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                        type: 1,
                        closeBtn: 2,
                        title: "查询员工信息",//弹出框标题
                        area: ['40%', '20%'],// $('#id')
                        content: $('#selectdiv'),
                        skin: 'demo-class',
                        success: function (layero, index) {
                            $('#selectdiv').css({"display": "block"});
                            $('#selectMember').click(function () {
                                //获取会员名
                                var memName = $('#memName').val();
                                table.reload('memTable', {
                                    method: 'post'
                                    , url: "/member/selectWhereMembers.action"
                                    , where: {
                                        //根据获取的会员名查询会员信息
                                        memName: memName,
                                        page: 1,
                                        limit: 10
                                    }
                                });
                            });
                        },
                        // 结束时隐藏弹出框
                        end: function (layero, index) {
                            $('#selectdiv').css({"display": "none"});
                        }
                    });
                    break;
                case 'upload':
                    $("#secondform").css({"display": " inline-block"});

                    $("#secondsum").unbind('click').bind('click',function(){
                        var data=new FormData($("#secondform")[0]);
                        $.ajax({
                            url:"/addController/batchimportMember.action",
                            type:'post',
                            data:data,
                            processData: false,
                            contentType: false,
                            success: function (data1) {
                                if(data1!=0){
                                    layui.use('table', function() {
                                        var table = layui.table //表格
                                        table.reload("listReload")
                                        $("#secondform").css({"display": " none"});
                                    })
                                }else{
                                    window.alert("数据表格式错误")
                                }
                            }
                        })
                    })
            }

        });
    });
</script>

</body>
</html>