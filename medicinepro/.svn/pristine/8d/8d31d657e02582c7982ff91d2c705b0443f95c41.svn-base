<!DOCTYPE html>
<!--
描述：该页面为supplierBody供货商管理主体页面，关联supplier.html
制作人：匡佩
完成时间：2019-11-23 https://fly.layui.com/extend/order/hot
-->
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>supplierBody供货商管理主体</title>
    <link rel="stylesheet" href="layui/css/layui.css?t=1573457678857" media="all">

    <style>
        body {
            margin-top: -10px;
        }

        /*表单样式*/
        .aaa {
            width: 150px;
            height: 20px;
        }

        table tr td {
            padding-top: 10px;
        }

        .bbb {
            width: 80px
        }

        /*自定义layer.tab的skin皮肤颜色*/
        body .demo-class .layui-layer-title {
            background: #1e1e19;
            color: #fff;
            border: none;
        }

        body .demo-class .layui-layer-btn {
            border-top: 1px solid #E9E7E7
        }

        body .demo-class .layui-layer-btn a {
            background: #333;
        }

        body .demo-class .layui-layer-btn .layui-layer-btn1 {
            background: #999;
        }

        /*新增表单按钮居中*/
        .but {
            padding-left: 65px
        }
        /* 搜索框样式*/
        .soso{
            margin-left: 300px;
        }
    </style>
</head>
<body>

<table class="layui-hide" id="demo" lay-filter="test" lay-data="{id: 'idTest'}">
   <!-- 页面顶部搜索框-->
    <div class="demoTable" style="margin-top:15px;">
        <button type="reset" class=" layui-btn layui-btn-primary layui-btn-sm soso" id="back" layui-btn-xs><i class="layui-icon"></i></button>
        <div class="layui-inline">
            <input class="layui-input" id="demoReload" name="search" placeholder="请输入搜索内容"  autocomplete="off" title="可以搜索供货商编号，供货商名称，地址，电话，联系人">
        </div>
        <button class="layui-btn searchBtn" data-type="reload" layui-btn-xs>搜索</button>
    </div>

</table>
<!-- 选择角色的按钮 -->
<div class="layui-row" id="popSearchRoleTest" style="display: none">
    <div class="layui-col-md11">
        <form class="layui-form" lay-filter="formTestFilter2121" id="form"><!--  method="post",action="/supplierInsert.action"-->
            <table style="margin-left: 30px" id="table_manage">
                <tr>
                    <td>供货商编号：</td>
                    <td><input type="text" name="supID" class="aaa" id="aaa" disabled="true"></td>
                </tr>
                <tr>
                    <td>供货商名称：</td>
                    <td><input type="text" name="supName" placeholder="请输入供货商名称" class="aaa layui-form"></td>
                </tr>
                <tr>
                    <td style="display: none">联系地址：</td>
                    <td style="display: none"><input type="text" name="supAddress" placeholder="请输入联系地址" class="aaa layui-form"></td>
                </tr>
                <tr>
                    <td style="display: none">联系编号：</td>
                    <td style="display: none"><input type="text" name="supAddressNo" placeholder="请输入联系编号" class="aaa layui-form"></td>
                </tr>
                <tr>
                    <td>请选择省：</td>
                    <td>
                        <select name="proID" id="proName" lay-ignore class="aaa province-selector" lay-filter="proName">
                            <option value="" >省</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>请选择市：</td>
                    <td>
                        <select  name="citID" id="citName" lay-ignore class="aaa province-selector" lay-filter="citName">
                            <option value="" >市</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>请选择区：</td>
                    <td>
                        <select name="disID" id="disName" lay-ignore class="aaa province-selector" lay-filter="disName">
                            <option value="" >区/县</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>所属地区：</td>
                    <td><input type="text" name="supRegion" placeholder="请输入所属地区" class="aaa layui-form"></td>
                </tr>
                <tr>
                    <td>联系人：</td>
                    <td><input type="text" name="supLinkman" placeholder="请输入联系人" class="aaa layui-form"></td>
                </tr>
                <tr>
                    <td>联系电话：</td>
                    <td><input type="text" name="supPhone" placeholder="请输入联系电话" class="aaa layui-form"></td>
                </tr>

                <tr>
                    <td>期初应付：</td>
                    <td><input type="text" name="supMoney" placeholder="￥0.00" autocomplete="off" class="bbb layui-form"></td>
                </tr>
                <tr>
                    <td>默认供货商：</td>
                    <td><input type="checkbox" name="supDefault" class="aaa layui-form" lay-skin="primary" value="1"></td>
                </tr>
                <tr>
                    <td>备注：</td>
                    <td><textarea placeholder="请输入内容" class="layui-textarea layui-form" name="supComment"></textarea></td>
                </tr>
                <tr>
                    <td class="but">
                        <button lay-submit lay-filter="*" id="LAY-component-form-getval"
                                class="layui-btn layui-btn-sm layui-btn-radius">提交
                        </button>
                    </td>
                    <td class="but">
                        <button type="reset" class="layui-btn layui-btn-sm layui-btn-radius">重置</button>
                    </td>
                </tr>
            </table>
        </form>
    </div>
</div>
<script src="layui/layui.all.js?t=1573457678857"></script>
<script src="layui/layui.js?t=1573457678857"></script>
<script>
    layui.config({
        version: '1573457678857' //为了更新 js 缓存，可忽略
    });
    layui.use(['laydate', 'table', 'element', 'form','layer'], function () {
        var table = layui.table //表格
            , $ = layui.$
            , element = layui.element//元素操作
            , laypage = layui.laypage;//分页
        var form = layui.form;
        var layer = layui.layer;
        //监听Tab切换
        element.on('tab(demo)', function (data) {
            layer.tips('切换了 ' + data.index + '：' + this.innerHTML, this, {
                tips: 1
            });
        });
        //搜索框搜索数据后回退到搜索之前
        $(document).on('click','#back',function(){
            table.reload('idTest', {
                method:'post',
                url:'/supplieManager/searchSuppliermapList.action'
            }, 'data');
            $('#demoReload').val("")
        });
        //执行一个 table 实例
        table.render({
            elem: '#demo'
            , height: 490//表单的高
            , width: 1150//表单的宽
            ,id: 'idTest'
            , url: '/supplieManager/searchSuppliermapList.action' //数据接口
            , title: '供货商表'
            , shade: 0//不显示遮罩
            , page: true //开启分页
            , limits: [10, 20, 50]  //每页条数的选择项，默认：[10,20,30,40,50,60,70,80,90]。
            , limit: 10 //每页默认显示的数量
            /*,method:'post'  //提交方式*/
            , skin: 'line ' //表格风格 line （行边框风格）row （列边框风格）nob （无边框风格）
            , toolbar: 'default' //开启工具栏，此处显示默认图标，可以自定义模板，详见文档true/default
            , totalRow: true //开启合计行
            , cols: [[ //表头
                {type: 'checkbox', fixed: 'left'}//LAY_CHECKED:true默认单选框选中
                , {field: 'supID', title: '供货商编号', width: 120, align: 'center', sort: true, totalRowText: '合计：'}//sort: true排序
                , {field: 'supName', title: '供货商名称', align: 'center', width: 150}
                , {field: 'supLinkman', title: '联系人', align: 'center', width: 90}
                , {field: 'supPhone', title: '联系电话', align: 'center', width: 120}
                , {field: 'supMoney', title: '我方应付金额', width: 120, align: 'center', totalRow: true, sort: true}// totalRow: true合计
                , {field: 'supAddress', title: '详细地址', align: 'center', width: 210}
                // , {field: 'supRegion', title: '所属地区', align: 'center', width: 160}
                , {
                    field: 'supDefault', title: '默认供货商', align: 'center', width: 100,
                    templet: function (row) {
                        var html = "<input type='checkbox' lay-skin='primary'" +
                            " lay-filter='checkboxIsSelected' table-index='"
                            + row.LAY_TABLE_INDEX + "' class='checkboxIsSelected' value='1' ";
                        if (row.supDefault == 1) {
                            html += " checked ";
                        }
                        html += ">";
                        return html;
                    }
                }
                , {field: 'supComment', align: 'center', title: '备注', width: 180}
            ]], parseData: function (res, curr, count) { //res 即为原始返回的数据 //curr得到当前页码//count得到数据总量
                return {
                    "code": res.status, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "count": res.count, //解析数据长度
                    "data": res.row //解析数据列表
                };
            }, done: function (obj) {//复选框函数
                layer.closeAll();
                form.on('checkbox(checkboxIsSelected)', function (data) {
                    var _index = $(data.elem).attr('table-index') || 0;
                    if (data.elem.checked) {
                        obj.data[_index].supDefault = data.value;
                    } else {
                        obj.data[_index].supDefault = 2;
                    }
                });
                var supplierList = table.cache.js_table_reource_invite_supplier_index_table;
            }

    });
        //搜索功能实现
         $ = layui.$; active = {
            reload: function(){
                var demoReload = $('#demoReload');
                var search=demoReload.val();
                alert("demoReload.val:" + search);
                //执行重载
                table.reload('idTest', {
                    method:'post',
                    url:'/supplieManager/searchselect.action',
                    data:"search="+search,
                    page: {
                        curr: 1 //重新从第 1 页开始
                    }
                    ,where: {
                        search: demoReload.val()  //搜索关键词
                    }
                }, 'data');
            }
        };

        //执行关键字搜索的函数
        $('.demoTable .layui-btn').on('click', function(){
            type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
        //省市区功能

        //监听头工具栏事件
        table.on('toolbar(test)', function (obj) {
            var checkStatus = table.checkStatus(obj.config.id)
                , data = checkStatus.data; //获取选中的数据
            switch (obj.event) {
                case 'add':
                    $.ajax({
                        type:"POST",
                        url:'/supplieManager/selectAllprovince.action',  //从数据库查询返回的是个list
                        dataType: "json",
                        success: function (data) {
                            //window.alert(JSON.stringify(data));
                            /*$("#proName").html("");
                            $("#citName").html("");
                            $("#disName").html("");*/
                            $.each(data,function(index,item){
                                $('#proName').append(new Option(item.proName,item.proId));//往下拉菜单里添加元素
                            });
                            form.render();
                        }
                    });
                    $("#proName").change(function () {
                        $("#citName").html("");
                        $("#disName").html("");
                        var checkred=JSON.stringify($("#proName option:selected").val());
                        //alert(checkred);
                        // var aa=JSON.stringify($("#proName").val());
                        //alert(aa);
                        $.ajax({
                            type:"POST",
                            url:'/supplieManager/selectAllCity.action?processId='+checkred,  //从数据库查询返回的是个list
                            dataType: "json",
                            success: function (data) {
                                $.each(data,function(index,item){
                                    $('#citName').append(new Option(item.citName,item.citId));//往下拉菜单里添加元素
                                });
                                form.render();
                            }
                        })
                    });
                    $("#citName").change(function () {
                        $("#disName").html("");
                        var checkrede=$("#citName option:selected").val();
                        //alert(checkrede);
                        //var bb=$("#citName").val();
                        //alert(bb);
                        $.ajax({
                            type:"POST",
                            url:'/supplieManager/selectAllArea.action?cityId='+checkrede,  //从数据库查询返回的是个list
                            dataType: "json",
                            success: function (data1) {
                                $.each(data1,function(index,item){
                                    $('#disName').append(new Option(item.disName,item.disId));//往下拉菜单里添加元素
                                });
                                form.render();
                            }
                        })

                    });
                    $.ajax({
                        type:"post",
                        url:"/supplieManager/searchSupplierIdMax.action",

                        success: function (data2) {
                            //window.alert(data2);
                            var supId= $("#aaa");
                            supId.val(data2)
                        }
                    });
                    /*layer.msg('添加');*/
                    layer.open({
                        //layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                        type: 1,
                        closeBtn: 2,//×的样式
                        /*moveOut: false,*///弹出框是否可以移出
                        shade: 0,//不显示遮罩
                        title: "新增供货商信息",
                        area: ['40%', '93%'],//增加框的宽高
                        content: $('#popSearchRoleTest'),// $('#id')
                        skin: 'demo-class'//自定义样式风格
                    });
                    layer.close(//当单击新增按钮表单数据清空
                        $('#form')[0].reset()
                    );
                    form.on('submit(*)', function (data) {
                        //var dataValue = data.field;//当前容器的全部表单字段，名值对形式：{name: value}
                        //获取省市区的编号
                        var citId=$("#citName option:selected").val();
                        var proId=$("#proName option:selected").val();
                        var disId=$("#disName option:selected").val();
                        /*window.alert(proId);
                        window.alert(citId);
                        window.alert(disId);*/
                        data = form.val('formTestFilter2121');
                        var dataVa=JSON.stringify(data);
                        //alert( "/supplierInsert.action?proId="+proId+"&citd="+citId+"&disId="+disId);
                        $.ajax({
                            type: "post"//请求提交方式,
                            , url: "/supplieManager/supplierInsert.action?proId="+proId+"&citId="+citId+"&disId="+disId
                            , data:dataVa
                            ,async: false
                            , contentType:"application/json;charset=UTF-8"
                            , success:function (checkStatus) {
                                layer.close(index);//关闭窗口
                                table.reload('idTest');//刷新，更新数据
                                form.render();
                            }});
                        /*layer.close(//当单击新增按钮表单数据清空
                            $('#proName')[0].reset(),
                            $('#citName')[0].reset(),
                            $('#disName')[0].reset()
                        );*/
                        location.reload();
                        return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
                    }, function(data) {//回调函数
                        //alert(JSON.stringify(data));
                    });
                    /*显示传递参数
                    layui.$('#LAY-component-form-getval').on('click', function () {
                        data = form.val('formTestFilter2121');
                        alert(JSON.stringify(data));
                    });*/
                    break;
                case 'update':

                    if (data.length === 0) {
                        layer.msg('请选择一行');
                    } else if (data.length > 1) {
                        layer.msg('只能同时编辑一个');
                    } else {
                        $.ajax({
                            type:"POST",
                            url:'/supplieManager/selectAllprovince.action',  //从数据库查询返回的是个list
                            dataType: "json",
                            success: function (data3) {
                                $.each(data3,function(index,item){
                                    $('#proName').append(new Option(item.proName,item.proId));//往下拉菜单里添加元素
                                });
                                var checkred=JSON.stringify(data[0].address.addProvinceNo);
                               // alert(checkred);

                                $("#proName").val(data[0].address.addProvinceNo);
                                $.ajax({
                                    type:"POST",
                                    url:'/supplieManager/selectAllCity.action?processId='+checkred,  //从数据库查询返回的是个list
                                    dataType: "json",
                                    success: function (data1) {
                                        $.each(data1,function(index1,item1){
                                            $('#citName').append(new Option(item1.citName,item1.citId));//往下拉菜单里添加元素
                                        })
                                        form.render();
                                         $("#citName").val(data[0].address.addCityNo);
                                        var checkrede2=$("#citName option:selected").val();
                                        //alert(checkrede2);

                                        $.ajax({
                                            type:"POST",
                                            url:'/supplieManager/selectAllArea.action?cityId='+checkrede2,  //从数据库查询返回的是个list
                                            dataType: "json",
                                            success: function (data2) {
                                                $.each(data2,function(index2,item2){
                                                    $('#disName').append(new Option(item2.disName,item2.disId));//往下拉菜单里添加元素
                                                });
                                                form.render('select');
                                                $("#disName").val(data[0].address.addDistrictNo);
                                            }
                                        })
                                        form.render('select');
                                    }
                                });
                                form.render('select');
                            }

                        });
                        //$("#proName").html("");
                       /* $("#citName").html("");
                        $("#disName").html("");*/
                       /* $("#citName").val("")
                        $('#disName option:selected').remove()*/
                        form.render();
                        $.ajax({
                            type:"POST",
                            url:'/supplieManager/selectAllprovince.action',  //从数据库查询返回的是个list
                            dataType: "json",
                            success: function (data) {
                                //window.alert(JSON.stringify(data));
                                $("#proName").change(function () {
                                //$("#proName").html("");
                                $("#citName").html("");
                                $("#disName").html("");
                                $.each(data,function(index,item){
                                    $('#proName').append(new Option(item.proName,item.proId));//往下拉菜单里添加元素
                                });
                                form.render('select');

                                });
                            }
                        });
                        $("#proName").change(function () {
                            $("#citName").html("");
                            $("#disName").html("");
                            var checkred=JSON.stringify($("#proName option:selected").val());
                            //alert(checkred);
                            // var aa=JSON.stringify($("#proName").val());
                            //alert(aa);
                            $.ajax({
                                type:"POST",
                                url:'/supplieManager/selectAllCity.action?processId='+checkred,  //从数据库查询返回的是个list
                                dataType: "json",
                                success: function (data) {
                                    //$("#disName").html("");
                                    $.each(data,function(index,item){
                                        $('#citName').append(new Option(item.citName,item.citId));//往下拉菜单里添加元素
                                    });
                                    form.render('select');

                                }
                            })
                        });
                        $("#citName").change(function () {
                            $("#disName").html("");
                            var checkrede=$("#citName option:selected").val();
                            //alert(checkrede);
                            //var bb=$("#citName").val();
                            //alert(bb);
                            $.ajax({
                                type:"POST",
                                url:'/supplieManager/selectAllArea.action?cityId='+checkrede,  //从数据库查询返回的是个list
                                dataType: "json",
                                success: function (data1) {
                                    $.each(data1,function(index,item){
                                        $('#disName').append(new Option(item.disName,item.disId));//往下拉菜单里添加元素
                                    });
                                    //form.render();
                                    form.render('select');

                                }
                            })
                            //$('#citName')[0].reset()
                        });
                        /*$("#proName").html("");
                        $("#citName").html("");
                        $("#disName").html("");*/
                        layer.open({
                            //layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                            type: 1,
                            closeBtn: 2 ,//×的样式
                            shade: 0,//不显示遮罩
                            title: "编辑供货商信息",
                            area: ['40%', '93%'],//增加框的宽高
                            content: $('#popSearchRoleTest'),// $('#id')
                            skin: 'demo-class',//自定义样式风格
                            success: function (layero, index) {//JQ函数
                                $('#popSearchRoleTest').css({"display": "block"});
                                form.on('submit(*)', function (data) {
                                    var citId=$("#citName option:selected").val();
                                    var proId=$("#proName option:selected").val();
                                    var disId=$("#disName option:selected").val();
                                    data = form.val('formTestFilter2121');
                                    var dataVa=JSON.stringify(data);
                                    //alert(JSON.stringify(data));
                                    $.ajax({
                                        type: "post"//请求提交方式,
                                        , url: "/supplieManager/supplierUpdate.action?proId="+proId+"&citId="+citId+"&disId="+disId
                                        , data:dataVa
                                        , contentType:"application/json;charset=UTF-8"
                                        , success:function (checkStatus) {
                                            layer.close(index);//关闭窗口
                                            table.reload('idTest');//刷新，更新数据
                                            //window.alert('编辑成功 ');
                                            form.render();
                                        }
                                    });
                                   /* layer.close(//当单击新增按钮表单数据清空
                                        $('#proName')[0].reset(),
                                        $('#citName')[0].reset(),
                                        $('#disName')[0].reset()
                                    );*/
                                    return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
                                });

                            }
                        });
                        /*console.log(checkStatus.data[0].address.addProvinceNo);
                        console.log(checkStatus.data[0].address.addCityNo);
                        console.log(checkStatus.data[0].address.addDistrictNo);*/
                        //表单赋值：为编辑中的表单添加数据库中的数据

                        form.val('formTestFilter2121', {
                            "supID": checkStatus.data[0].supID
                            , "supName": checkStatus.data[0].supName
                            , "supLinkman": checkStatus.data[0].supLinkman
                            , "supPhone": checkStatus.data[0].supPhone
                            , "supMoney": checkStatus.data[0].supMoney
                             /*, "proID": checkStatus.data[0].proID*/
                            // , "citID": checkStatus.data[0].address.addCityNo
                            // , "disID": checkStatus.data[0].address.addDistrictNo
                            , "supAddressNo": checkStatus.data[0].supAddressNo
                            , "supAddress": checkStatus.data[0].supAddress
                            , "supRegion": checkStatus.data[0].supRegion
                            , "supDefault": checkStatus.data[0].supDefault
                            , "supComment": checkStatus.data[0].supComment
                        });
                        //table.reload();
                        //form.render();
                    }
                    break;
                case 'delete':
                    if (data.length === 0) {
                        layer.msg('请选择一行');
                    } else {
                        layer.open({
                            content: '是否确认删除！',
                            yes: function(index, layero){
                                var checkStatus = table.checkStatus('idTest');
                                //alert(JSON.stringify(checkStatus.data[0].supID));
                                //定义一次性删除多条数据
                                var deleteNo="";
                                for(var i=0;data.length>i;i++) {
                                    var dataRowObj = checkStatus.data[i];
                                    var bookNostr = dataRowObj.supID;
                                    deleteNo += bookNostr + ",";
                                }
                                deleteNo=deleteNo.substring(0, deleteNo.length-1);//去掉多余的，
                                //console.log(deleteNo);
                                $.post(
                                    '/supplieManager/supplierDelete.action' , {supID:deleteNo},
                                    function (data) {
                                        /*table.reload('idTest', {
                                            method:'post',
                                            url:'/supplieManager/searchSuppliermapList.action'
                                        }, 'data');*/
                                        // layer.msg(checkStatus.msg);
                                        layer.close(index);//如果成功关闭窗口
                                        //table.reload('idTest');//刷新表单更新数据

                                        table.reload('idTest', {
                                            where: { //设定异步数据接口的额外参数，任意设
                                                //aaaaaa: 'xxx'
                                                //,bbb: 'yyy'
                                                //…
                                                url:'/supplieManager/searchSuppliermapList.action'
                                            }
                                            ,page: {
                                                curr: 1 //重新从第 1 页开始
                                            }
                                        }); //只重载数据
                                    });
                                layer.close(index); //如果设定了yes回调，需进行手工关闭
                            }

                        });

                    }
                    break;
            }
        });
    })
</script>
</body>
</html>