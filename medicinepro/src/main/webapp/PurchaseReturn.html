<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>采购退货</title>
    <link rel="stylesheet" href="layui/css/layui.css"  media="all">
    <style>
        body .demo-class .layui-layer-title{ color:darkblue; border: none;}
        #stock{margin-left: 0;}
        #stock_1{width:1165px;height:550px;border:1px solid #B4B4B4;margin-left:1px;background-color: #EBEBEB;}
        #stock_1 .stock_2{font-size:20px;text-align:center;font-weight:bold;margin-top:10px;}
        #stock_1 .stock_3{color:red;font-weight:bold;margin-top:-18px;margin-left: 880px;}
        .stock_4{width:1100px;height:90px;border:1px solid gray;margin-left:32px;margin-top:10px;}
        .stock_4 select{background-color:#EBEBEB;}
        .layui-form-label{margin-top:20px;}
        .layui-input-inline select{margin-top:28px;margin-left:-15px;border-color: #EDF2F8 #EDF2F8 black #EDF2F8;}
        #stock_5{margin-left: 300px;margin-top:-20px;}
        #stock_6 select{width:108px;border-color: #EDF2F8 #EDF2F8 black #EDF2F8;}
        #stock_6{margin-top: -22px;margin-left:373px;}
        #stock_8{margin-top: -46px;margin-left:555px;}
        #stock_8 #date{background-color:#EBEBEB;}
        #stock_8 .layui-input-inline input{margin-left:-10px;height:20px;margin-top:25px;border-color: #EDF2F8 #EDF2F8 black #EDF2F8;}
        #button{width:1100px;height:43px;border:1px solid #B4B4B4;margin-left:32px;margin-top:15px;}
        #button_1{margin-left:30px;}
        #button_2{margin-left:80px;}
        #button_1,#button_2{margin-top:2px;width:150px;background-color: #88A3D4;}
        #button_4{width:1100px;height:210px;border:1px solid #B4B4B4;margin-left:32px;margin-top:15px;}
        #button_7 select{width:130px;height:25px;border-bottom: 1px solid black;}
        #button_16{position: relative;top:20px;}
        /*表格下面*/
        #footer_div{border:1px solid #EBEBEB;width:1100px;height: 80px;margin-left: 32px;margin-top: 2px;}
        /*应退金额*/
        #shouldMoney{margin-top: 5px;margin-left: 10px;}
        #footer_span1,#footer_span2{border-bottom: 1px solid black;width:80px;height:15px;display: inline-block;}
        /*实退金额*/
        #ReallyMoney,#footer_operator{margin-top:5px;margin-left: 200px;}
        /*经办人*/
        #employees{border-bottom: 1px solid black;width:80px;height:18px;background-color:#EBEBEB;display: inline-block;}
        #footer_div2{margin-top: 18px;}
        /*备注*/
        #footer_remark{margin-left: 7px;}
        #footer_input1{border-bottom: 1px solid black;background-color:#EBEBEB;width:500px;height:20px;display: inline-block;}
        /*保存按钮*/
        #footer_save{background-color: #88A3D4;border:1px solid #B4B4B4;color: white;margin-top:-40px;margin-left: 900px;}
        /*取消按钮*/
        /*#footer_cancel{background-color: #88A3D4;border:1px solid #B4B4B4;color: white;margin-top:-40px;margin-left: 50px;}*/
    </style>

</head>
<body>
<div id="stock" >
    <div id="stock_1">
        <div class="stock_2">采购退货</div>
        <div class="stock_3">单号：<span id="odd"></span></div>
        <div class="stock_4">
            <label class="layui-form-label">供货商：</label>
            <div class="layui-input-inline">
                <select id="supplier" name="supplier" lay-verify="required" lay-search="">
                </select>
            </div>
            <i id="button_16" class="layui-icon layui-icon-search" style="font-size: 25px; color: #1E9FFF;"></i>
            <div id="stock_5">收货仓库：</div>
            <div id="stock_6">
                <select id="warehouse" name="warehouse" lay-verify="required" lay-search="">
                </select>
            </div>
            <div id="stock_8">
                <div class="layui-inline">
                    <label class="layui-form-label">进货日期：</label>
                    <div class="layui-input-inline">
                        <input type="text" name="date" id="date" lay-verify="date" placeholder="2019-11-25" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
        </div>
        <div id="button">
            <button id="button_1" type="button" class="layui-btn layui-btn-radius">添加退货商品（F2）</button>
            <button id="button_2" type="button" class="layui-btn layui-btn-radius">整单退货（F7）</button>
        </div>
        <!--中间表格-->
        <div id="button_4">
            <table class="layui-hide" id="test"></table>
        </div>

        <!--尾部-->
        <div id="footer_div">
            <div>
                <label id="shouldMoney">应退金额：</label>
                <span id="footer_span1"></span>
                <label id="ReallyMoney">实退金额：</label>
                <span id="footer_span2"></span>
                <label id="footer_operator">经办人：</label>
                <select id="employees" name="employees" lay-verify="required" lay-search="">

                </select>
            </div>
            <div id="footer_div2">
                <label id="footer_remark">备&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注：</label>
                <input id="footer_input1" type="text" name="title" lay-verify="title" autocomplete="off" class="layui-input">
            </div>
            <button  id="footer_save" type="submit" class="layui-btn layui-btn-primary layui-btn-radius layui-btn-xs">保存（F5）</button>
          <!--  <button  id="footer_cancel" type="button" class="layui-btn layui-btn-primary layui-btn-radius layui-btn-xs">退出（F6）</button>-->
        </div>
    </div>
</div>
<script src="layui/layui.js" charset="utf-8"></script>
<script src="JQuery/jquery-3.4.1.min.js"></script>
<script>
    var choose;
    //添加单击事件【将增加商品(采购退货)添加至采购退货】
    $('#button_1').on('click',function () {
        var wareHourseNo=$('#warehouse').val();
        var supplierNo=$('#supplier').val();
        window.PartitionId =wareHourseNo+ ","+supplierNo;
        choose="old";
        layer.open({
            type: 2,
            title:'增加商品(采购退货)'
            ,content:'purchasingReturn.html'
            ,area:['905px','550px']
            ,skin: 'demo-class'
        });
    })

    //添加单击事件【将采购进货、退货查询添加至采购退货】
    $('#button_2').on('click',function () {
        var wareHourseNo=$('#warehouse').val();
        //var supplierNo=$('#supplier').val();
        window.PartitionId =wareHourseNo;
        choose="abc";
        layer.open({
            type: 2,
            title:'采购进货、退货查询'
            ,content:'StockAndGoodsReturnSearch.html'
            ,area:['950px','550px']
            ,skin: 'demo-class'
        });
    });

    //退出按钮
   /* var turnoff;
    $('#footer_cancel').on('click',function () {
        //window.alert("退出")
        layer.close(turnoff);//关闭当前页
        parent.location.reload();//刷新页面
    })*/
    //动态获取下拉列表
    layui.use(['form', 'layedit', 'laydate'], function() {
        var form = layui.form
            ,layer = layui.layer
            ,layedit = layui.layedit
            ,laydate = layui.laydate;
        //1、供货商
        $.ajax({
            type:"POST",
            url:'/GoodsReturnSearch/supplierListSearch.action',  //从数据库查询返回的是个list
            dataType: "json",
            success: function (data) {
                //window.alert(JSON.stringify(data));
                $.each(data,function(index,item){
                    $('#supplier').append(new Option(item.supName,item.supID));//往下拉菜单里添加元素
                })
                form.render();//菜单渲染 把内容加载进去
            }
        })
        //2、仓库名称
        $.ajax({
            type:"POST",
            url:'/GoodsReturnSearch/warehouseListSearch.action',  //从数据库查询返回的是个list
            dataType: "json",
            success: function (data) {
                //window.alert(JSON.stringify(data));
                $.each(data,function(index,item){
                    $('#warehouse').append(new Option(item.warName,item.warID));//往下拉菜单里添加元素
                })
                form.render();//菜单渲染 把内容加载进去
            }
        })
        //3、经办人
        $.ajax({
            type:"POST",
            url:'/allocationManager/searchEmployeesJin.action',
            dataType: "json",
            success: function (data) {
                //window.alert(JSON.stringify(data));
                $.each(data,function(index,item){
                    $('#employees').append(new Option(item.empName,item.empNo));//往下拉菜单里添加元素
                })
                form.render();//菜单渲染 把内容加载进去
            }
        })
        //获得单号
        $.ajax({
            url: '/MerchBillReturn/searchStockOdd.action',
            type: 'post',
            success: function (data) {
                $('#odd').text(data);
                $('#odd').css({"color": "red"});
            }
        });
        laydate.render({
            elem: '#date'
            , type: 'date'
            , value: new Date()
        });
    });

    /*layui.use('layer', function(){ //独立版的layer无需执行这一句
        var $ = layui.jquery, layer = layui.layer; //独立版的layer无需执行这一句
        //触发事件
       /!* var active = {
            offset: function(othis){
                var type = othis.data('type')
                    ,text = othis.text();
                    turnoff=layer.open({
                    area:['977px', '558px'],
                    skin: 'demo-class',
                    title:text,
                    type: 1
                    ,offset: type //具体配置参考：http://www.layui.com/doc/modules/layer.html#offset
                    ,id: 'layerDemo'+type //防止重复弹出
                    ,content:$('#stock ')
                    ,btnAlign: 'c' //按钮居中
                    ,shade: 0 //不显示遮罩
                    ,yes: function(){
                        layer.closeAll();
                    }
                    ,end:function () {
                        $("#stock").css({"display":"none"})
                    }
                });

            }
        };*!/

        $('#layerDemo .layui-btn').on('click', function(){
            var othis = $(this), method = othis.data('method');
            active[method] ? active[method].call(this, othis) : '';
        });

    });*/
    /*layui.use(['form', 'layedit', 'laydate'], function() {
        var form = layui.form
            ,layer = layui.layer
            ,layedit = layui.layedit
            ,laydate = layui.laydate;

        //日期
        laydate.render({
            elem: '#date'
        });
        laydate.render({
            elem: '#date1'
        });
        laydate.render({
            elem: '#datea'
        });
        laydate.render({
            elem: '#date1a'
        });
    });*/


    //创建全局变量保存子弹窗传的参
    var tableData=[];
    //第一次渲染没有数据
    saledCom1(tableData);
    //添值方法(与子弹窗一致)
    function saledCom(checkData){
        //var  checkData= table.checkStatus('comsearch'); //获取选中行
        if(tableData.length > 0){//判断全局数组是否有数据
            for(var i = 0; i < checkData.length; i++){//循环选中每条的数据
                var states = false;//定义重复状态
                for(var y = 0; y < tableData.length; y++){//循环全局数组数据
                    if(checkData[i].commodity.comId == tableData[y].commodity.comId){
                        states = true;//有重复改变重复状态为真
                        //有重复值数量＋1
                        tableData[y].duo1=Number(tableData[y].duo1)+1;
                    }
                }
                if(!states){//判断不重复则将选中的数据插入全局数组中
                    tableData.push(checkData[i]);
                }
            }

        }else{
            tableData=checkData;
        }
        saledCom1(tableData)
    };

    //第一次查询表格数据【无数据】
    layui.use('table', function(){
        var table = layui.table;
        table.render({
            elem: '#test'
            ,url:'/GoodsReturnSearch/SearchPurchaseReturn.action'
            ,height:210
            ,cols: [[
                {type:'checkbox', fixed: 'left'}
                ,{templet:'<div>{{d.commodity.comId}}</div>', width:100, title: '商品编号',align: 'center'}
                ,{templet:'<div>{{d.commodity.comName}}</div>', width:150, title: '商品名称',align: 'center'}
                ,{field:'redUnit', width:80, title: '单位', width:80,align: 'center'}
                ,{field:'redredduct', width:80, title: '产品规格',width:120,align: 'center'}
                ,{field:'redPermitNo', title: '批准文号',width:100,align: 'center'} //minWidth：局部定义当前单元格的最小宽度，layui 2.2.1 新增
                ,{field:'experience', title: '产品批号',width:120, align: 'center'}
                ,{field:'comStarTime',templet:'<div>{{d.commodity.comStarTime}}</div>', title: '生产日期', width:180,align: 'center'}
                ,{field:'redValidUntil',templet:'<div>{{d.commodity.comEndTime}}</div>', title: '有效期至',width:180,align: 'center'}
                ,{field:'redPrice', width:137, title: '单价', width:80,align: 'center'}
                ,{field:'duo1', width:137, title: '数量',width:80, align: 'center'}
                ,{field:'wealth', width:137, title: '总金额',width:80,templet: function (d) {
                    return d.redPrice*d.duo1;
                 }}
                ,{templet:'<div>{{d.manufacturer.manName}}</div>', width:120, title: '生产厂商',align: 'center'}
            ]]
            ,parseData: function (res, curr, count) { //res 即为原始返回的数据 //curr得到当前页码//count得到数据总量
                return {
                    "code": res.status, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "count": res.count, //解析数据长度
                    "data": res.row //解析数据列表
                };
            }
            ,done:function (obj) {

            }
        });
    });

    //第二次查询根据整单退货中的单号查询采购退货表格信息
    function StockGoods(recOdd,tableData) {
        layui.use('table', function(){
            var table = layui.table;
            table.render({
                elem: '#test'
                ,url:'/GoodsReturnSearch/SearchPurchaseReturnByRecNo.action'
                ,where:{recOdd: recOdd}
                ,height:210
                ,data:tableData
                ,totalRow:true
                , id: "saleTable"
                ,page:true
                ,cols: [[
                    {type:'checkbox', fixed: 'left'}
                    ,{templet:'<div>{{d.commodity.comId}}</div>', width:100, title: '商品编号',align: 'center',totalRowText: '合计'}
                    ,{templet:'<div>{{d.commodity.comName}}</div>', width:150, title: '商品名称',align: 'center'}
                    ,{field:'redUnit', width:80, title: '单位', width:80,align: 'center'}
                    ,{field:'redredduct', width:80, title: '产品规格',width:120,align: 'center'}
                    ,{field:'redPermitNo', title: '批准文号',width:100,align: 'center'} //minWidth：局部定义当前单元格的最小宽度，layui 2.2.1 新增
                    ,{field:'experience', title: '产品批号',width:120, align: 'center'}
                    ,{field:'redDate',templet:'<div>{{d.commodity.comStarTime}}</div>', title: '生产日期', width:180,align: 'center'}
                    ,{field:'redValidUntil',templet:'<div>{{d.commodity.comEndTime}}</div>', title: '有效期至',width:180,align: 'center'}
                    ,{field:'redPrice', width:137, title: '单价', width:80,align: 'center'}
                    ,{field:'redCount', width:137, title: '数量',width:80,align: 'center',totalRow:true}
                    ,{field:'duo', width:137, title: '总金额',width:80,align: 'center',templet: function (d) {
                            return Number(d.redPrice)*Number(d.redCount);
                        }
                    }
                    ,{templet:'<div>{{d.manufacturer.manName}}</div>', width:120, title: '生产厂商',align: 'center'}
                ]]
                ,parseData: function (res, curr, count) { //res 即为原始返回的数据 //curr得到当前页码//count得到数据总量
                    return {
                        "code": res.status, //解析接口状态
                        "msg": res.msg, //解析提示文本
                        "count": res.count, //解析数据长度
                        "data": res.row //解析数据列表
                    };
                }
                ,done:function (obj) {
                    var onwanceTotal=0;//统计结算后余额
                    layui.each(obj.data,function(index,d){
                        onwanceTotal+=Number(d.redPrice)*Number(d.redCount);
                    })
                    //修改 结算后余额 统计单元格文本
                    this.elem.next().find('.layui-table-total td[data-field="duo"] .layui-table-cell').text(onwanceTotal);
                    //动态获取应退金额
                    $("#footer_span1").text(onwanceTotal);
                    //动态获取实退金额
                    $("#footer_span2").text(onwanceTotal);
                }
            });
        });
    }

    // 添加退货商品
    function saledCom1(tableData) {
        console.log(tableData);
        layui.use('table', function () {
            var table = layui.table,
                util = layui.util;
            table.render({
                elem: '#test'
                , data: tableData
                , height: 210
                , page: true
                , id: "saleTable"
                , totalRow: true //开启合计行
                ,cols: [[
                    {type:'checkbox', fixed: 'left'}
                    ,{templet:'<div>{{d.commodity.comId}}</div>', width:100, title: '商品编号',align: 'center',totalRowText: '合计'}
                    ,{templet:'<div>{{d.commodity.comName}}</div>', width:180, title: '商品名称',align: 'center'}
                    ,{templet: '<div>{{d.commodity.comUnit}}</div>', width:80, title: '单位', width:80,align: 'center'}
                    ,{templet: '<div>{{d.commodity.comProduct}}</div>', width:80, title: '产品规格',width:120,align: 'center'}
                    ,{templet: '<div>{{d.commodity.comApproval}}</div>', title: '批准文号',width:100,align: 'center'} //minWidth：局部定义当前单元格的最小宽度，layui 2.2.1 新增
                    ,{field:'experience', title: '产品批号',width:120, align: 'center'}
                    ,{templet: '<div>{{d.commodity.comStarTime}}</div>', title: '生产日期', width:180,align: 'center'}
                    ,{templet: '<div>{{d.commodity.comEndTime}}</div>', title: '有效期至',width:180,align: 'center'}
                    ,{templet: '<div>{{d.reqPrice}}</div>', title: '单价',width:80,align: 'center'}
                    ,{field:'duo1', width:137, title: '数量',width:80,edit:'text', align: 'center',totalRow:true,templet: function(d){
                            if(d.duo1>d.reqCurrent){
                                return d.reqCurrent
                            }else{
                                return d.duo1
                            }
                        }
                    }
                    ,{field:'duo3', width:137, title: '总金额',width:80,totalRow:true,align: 'center',templet: function (d) {
                            if(d.duo1>d.reqCurrent){
                                return Number(d.reqPrice)*Number(d.reqCurrent);
                            }else{
                                return Number(d.reqPrice)*Number(d.duo1);
                            }
                        }
                    }
                    ,{templet:'<div>{{d.commodity.manufacturer.manName}}</div>', width:120, title: '生产厂商',align: 'center'}
                ]]
                , done: function (obj) {
                    var onwanceTotal=0;//统计结算后余额
                    layui.each(obj.data,function(index,d){
                        if(d.duo1>d.reqCurrent){
                            onwanceTotal+=Number(d.reqPrice)*Number(d.reqCurrent)
                        }else{
                            onwanceTotal+=Number(d.reqPrice)*Number(d.duo1)
                        }
                    });
                    //修改 结算后余额 统计单元格文本
                    this.elem.next().find('.layui-table-total td[data-field="duo3"] .layui-table-cell').text(onwanceTotal);
                    //动态获取应退金额
                    $("#footer_span1").text(onwanceTotal);
                    //动态获取实退金额
                    $("#footer_span2").text(onwanceTotal);
                    //当表格有数据 回调将合计行小数点去除
                    if (tableData.length > 0) {
                        var a = $(".layui-table-total div:eq(9)").html();
                        a = a.substr(0, a.indexOf("."));
                        $(".layui-table-total div:eq(9)").html(a);
                    }
                }
            });
            //监听单元格编辑
            table.on('edit(saleTable)', function (obj) {
                var value = obj.value //得到修改后的值
                    , data = obj.data //得到所在行所有键值
                    , field = obj.field; //得到字段
                layer.msg('[ID: ' + data.id + '] ' + field + ' 字段更改为：' + value);
            });
            if (tableData.length > 0) {
                //执行重载
                table.reload('saleTable', {
                    data: tableData
                });
            }
        });
    }
    //当点击保存的时候
    $('#footer_save').click(function () {
        layui.use(['table', 'layer'], function () {
            var table = layui.table;
            var layer = layui.layer;
            //获得数据表格选择的数据
            var checkData = table.checkStatus('saleTable');
            //判断选择的长度
            if (checkData.data.length > 0) {//长度 >0 说明选择了数据
                //封装数据
                var supplier = $('#supplier').val();
                var warehouse = $('#warehouse').val();
                var employees = $('#employees').val();
                var odd = $('#odd').text();
                var remarks = $('#remarks').val();
                var date = $('#date').val();
                //window.alert(odd);
                $.ajax({
                    url: '/MerchBillReturn/addReceiptsMessage.action',
                    type: 'post',
                    data: {
                        "recOdd": odd,
                        "recEmployeeNo": employees,
                        "redDepotNo": warehouse,
                        "duo1":supplier,
                        "recRemark": remarks,
                        "recDate":date
                    }
                    , success: function (data) {
                        if (data == "success") {
                            var b = JSON.stringify(checkData.data);
                            if(choose == "old"){
                                $.ajax({
                                    url: '/MerchBillReturn/addReceiptsDetailedMessage.action',
                                    contentType: "application/json;charset=UTF-8",
                                    type: 'post',
                                    //dataType: 'json',
                                    data: b
                                    , success: function (data1) {
                                        if (data1 == "success") {
                                            tableData = [];
                                            saledCom1(tableData);
                                            layer.msg('保存成功');
                                            location.reload();
                                        }
                                    }
                                });
                            }else if(choose == "abc"){
                                $.ajax({
                                    url: '/MerchBillReturn/addReceiptsDetailedMessageReturn.action',
                                    contentType: "application/json;charset=UTF-8",
                                    type: 'post',
                                    data: b
                                    , success: function (data1) {
                                        if (data1 == "success") {
                                            tableData = [];
                                            saledCom1(tableData);
                                            layer.msg('保存成功');
                                            window.parent.location.reload();
                                        }
                                    }
                                });
                            }
                        }
                    }
                });
            } else {//长度==0 说明没有选择数据
                layer.msg('请至少选择一条数据', {
                    time: 5000, //20s后自动关闭
                    btn: ['明白了', '好的']
                });
            }
        });
    });
</script>
</body>
</html>