<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>采购进货</title>
    <link rel="stylesheet" href="layui/css/layui.css"  media="all">
    <style>
        body .demo-class .layui-layer-title{ color:darkblue; border: none;}
        #stock_1{width:1165px;height:550px;border:1px solid #B4B4B4;margin-left:1px;background-color: #EBEBEB;margin: 0 auto;}
        #stock_1 .stock_2{font-size:20px;text-align:center;font-weight:bold;margin-top:10px;}
        #stock_1 .stock_3{color:red;font-weight:bold;margin-top:-18px;margin-left: 880px;}
        .stock_4{width:1100px;height:90px;border:1px solid gray;margin-left:32px;margin-top:10px;}
        .stock_4 select{background-color:#EBEBEB;}
        .layui-form-label{margin-top:20px;}
        .layui-input-inline select{margin-top:28px;margin-left:-15px;border-color: #EDF2F8 #EDF2F8 black #EDF2F8;}
        #stock_5{margin-left: 300px;margin-top:-20px;}
        #stock_6 select{width:108px;border-color: #EDF2F8 #EDF2F8 black #EDF2F8;}
        #stock_6{margin-top: -22px;margin-left:373px;}
        #stock_8{margin-top: -46px;margin-left:555px;}
        #stock_8 #date{background-color:#EBEBEB;}
        #stock_8 .layui-input-inline input{margin-left:-10px;height:20px;margin-top:25px;border-color: #EDF2F8 #EDF2F8 black #EDF2F8;}

        /*老商品、新商品、导入导出*/
        #button{width:1100px;height:43px;border:1px solid #B4B4B4;margin-left:32px;margin-top:15px;}
        #button_1,#button_2,#button_3{margin:2px 0 0 30px;width:150px;background-color: #88A3D4;}
        #button_4{width:1100px;height:210px;border:1px solid #B4B4B4;margin-left:32px;margin-top:15px;}

        #button_16 input{width:130px;height:25px;border-color: #EBEBEB #EBEBEB black #EBEBEB;background-color:#EBEBEB;}

        /*底部的div*/
        #footer{/*border:1px solid red;*/height:80px;width:1100px;margin-left:32px;}
        #footer_div1{margin-top:5px;}
        /*应付金额*/
        .amountPayable{margin:5px 0 0 5px;}
        #amountPayableNumber{border-bottom: 1px solid black;width: 60px;height: 15px;display:inline-block;}
        /*实付金额、经办人*/
        .netMoney,.operator{margin: 5px 0 0 200px;}
        #netMoneyNumber{border-bottom: 1px solid black;width: 60px;height: 15px;display:inline-block;}
        #selectOperator{border-bottom:1px solid black;width:80px;height:25px;background-color:#EBEBEB; }

        #footer_div2{margin-top:10px;}
        /*备注*/
        .remark{margin-left:5px;}
        #remarkInput{width:500px;height:20px;border-color:#EBEBEB #EBEBEB black #EBEBEB;background-color:#EBEBEB;
            margin-top:-20px;display: inline-block;}
        /*按钮*/
        #save,#footer_cancle{color:white;height:30px;width:120px;line-height:30px;background-color:#88A3D4;margin-left:350px;}
        #button_26{position: relative;top:20px;}
    </style>

</head>
<body>
<!--<div class="site-demo-button" id="layerDemo" style="margin-bottom: 0;">
    <button data-method="offset" data-type="auto" class="layui-btn layui-btn-normal">采购进货</button>
</div>-->

<div id="stock" >
    <div id="stock_1">
        <form action="" method="post">
        <div class="stock_2">采购进货</div>
        <div class="stock_3">单号：<span id="odd"></span></div>
        <div class="stock_4">
                <label class="layui-form-label">供货商：</label>
                <div class="layui-input-inline">
                    <select name="modules" lay-verify="required" lay-search="" id="supplier">
                        <!--<option value="">普通供货商</option>
                        <option value="1">利民医药公司</option>
                        <option value="2">健康医药</option>-->
                    </select>
                </div>
            <i id="button_26" class="layui-icon layui-icon-search" style="font-size: 25px; color: #1E9FFF;"></i>
                    <div id="stock_5">收货仓库：</div>
                    <div id="stock_6">
                        <select name="modules" lay-verify="required" lay-search="" id="wareHoseNameOut">
                         <!--   <option value="">主仓库</option>
                            <option value="1">酒库</option>
                            <option value="2">饮料库</option>-->
                        </select>
                    </div>
            <div id="stock_8">
                <div class="layui-inline">
                    <label class="layui-form-label">进货日期：</label>
                    <div class="layui-input-inline">
                        <input type="text" name="date" id="date" lay-verify="date" placeholder="2019-11-25" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </div>
        </div>
        <div id="button">
            <button id="button_1" type="button" class="layui-btn layui-btn-radius">老商品添加（F2）</button>
            <button id="button_2" type="button" class="layui-btn layui-btn-radius">新商品添加（F9）</button>
           <!-- <button id="button_3" type="button" class="layui-btn layui-btn-radius">导入导出（F10）</button>-->
        </div>
        <div id="button_4">
            <table class="layui-hide" id="test"></table>
        </div>

        <div id="footer">
            <div id="footer_div1">
                <label class="amountPayable">应付金额：</label>
                <span id="amountPayableNumber"></span>
                <label class="netMoney">实付金额：</label>
                <span id="netMoneyNumber"></span>
                <label class="operator">经办人：</label>
                    <select id="selectOperator" name="modules" lay-verify="required" lay-search="">
                       <!-- <option value="">小张</option>
                        <option value="1">小陈</option>
                        <option value="2">小白</option>
                        <option value="3">小李</option>-->
                    </select>
            </div>
            <div id="footer_div2">
                <label class="remark" id="remarks">备&nbsp;&nbsp;注：</label>
                <input id="remarkInput" type="text" name="title" lay-verify="title" autocomplete="off" placeholder="" class="layui-input">
                <button  id="save" type="button" lay-submit="" class="layui-btn layui-btn-primary layui-btn-radius">保存（F5）</button>
                <!--<button  id="footer_cancle" type="button" class="layui-btn layui-btn-primary layui-btn-radius">退出（F6）</button>-->
            </div>
            </div>
        </form>
    </div>
<script src="JQuery/jquery-3.4.1.min.js"></script>
<script src="layui/layui.js" charset="utf-8"></script>
<script>

    //var closeIndex;
    //退出按钮
    /*$('#footer_cancle').on('click',function () {
        //window.alert("ghjkl");
        //关闭页面
       layer.close(closeIndex);
        //退出后刷新页面
       window.parent.location.reload();
    })*/
    //添加单击事件【将采购进货(老商品添加)添加至采购进货】
    $('#button_1').on('click',function () {
        var supplierNo=$('#supplier').val();
        window.PartitionId = supplierNo;
        layer.open({
            type: 2,
            title:'增加商品(采购进货)'
            ,content:'purchasingStock.html'
            ,area:['905px','610px']
            ,skin: 'demo-class'
        });
    })
    //添加单击事件【将新商品添加--添加至采购进货】
    $('#button_2').on('click',function () {
        layer.open({
            type: 2,
            title:'增加商品'
            ,content:'newAddition.html'
            ,area:['495px','570px']
            ,skin: 'demo-class'
            ,shade: 0
        });
    })

    layui.use('layer', function(){ //独立版的layer无需执行这一句
        var $ = layui.jquery, layer = layui.layer; //独立版的layer无需执行这一句

        //触发事件
       /* var active = {
            offset: function(othis){
                var type = othis.data('type')
                    ,text = othis.text();
                closeIndex=layer.open({
                    area:['943px', '558px'],
                    skin: 'demo-class',
                    title:text,
                    type: 1
                    ,offset: type //具体配置参考：http://www.layui.com/doc/modules/layer.html#offset
                    ,id: 'layerDemo'+type //防止重复弹出
                    ,content:$('#stock ')
                    ,btnAlign: 'c' //按钮居中
                    ,shade: 0 //不显示遮罩
                    ,yes: function(){
                        layer.closeAll();
                    }
                });

            }
        };*/

        $('#layerDemo .layui-btn').on('click', function(){
            var othis = $(this), method = othis.data('method');
            active[method] ? active[method].call(this, othis) : '';
        });

    });
    layui.use(['form', 'layedit', 'laydate'], function() {
        var form = layui.form
            ,layer = layui.layer
            ,layedit = layui.layedit
            ,laydate = layui.laydate;


        //单号日期
        laydate.render({
            elem: '#date'
            , type: 'datetime'
            , value: new Date()
            ,max: getNowFormatDate()
        });

        //防止单号日期选后面的日期
        function getNowFormatDate() {
            var date = new Date();
            var seperator1 = "-";
            var seperator2 = ":";
            var month = date.getMonth() + 1;
            var strDate = date.getDate();
            if (month >= 1 && month <= 9) {
                month = "0" + month;
            }
            if (strDate >= 0 && strDate <= 9) {
                strDate = "0" + strDate;
            }
            var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate
                + " " + date.getHours() + seperator2 + date.getMinutes()
                + seperator2 + date.getSeconds();
            return currentdate;
        }

        //获得单号
        $.ajax({
            url: '/merchBillManager/searchStockOdd.action',
            type: 'post',
            success: function (data) {
                $('#odd').text(data);
                $('#odd').css({"color": "red"});
            }
        });

        // 自动获取供货商的下拉框
        $.ajax({
            url: '/commodityManager/searchSupplierDao.action',
            dataType: 'json',
            data: {'state': 0},	//查询状态为正常的所有机构类型
            type: 'post',
            success: function (data) {
                var count = 0;
                $.each(data, function (index, item) {
                    count++;
                    $('#supplier').append(new Option(item.supName, item.supID));// 下拉菜单里添加元素
                    if (count == 1) {
                        $('#supplier').val(item.supID);
                    }
                });
                layui.form.render("select");
            }
        });

        // 自动获取仓库的下拉框
        $.ajax({
            url: '/wareHouseManager/searchWareHourseInfo.action',
            dataType: 'json',
            data: {'state': 0},	//查询状态为正常的所有机构类型
            type: 'post',
            success: function (data) {
                var count = 0;
                $.each(data, function (index, item) {
                    count++;
                    $('#wareHoseNameOut').append(new Option(item.warName, item.warID));// 下拉菜单里添加元素
                    //$('#wareHoseOut').append(new Option(item.warName, item.warID));// 下拉菜单里添加元素
                    if (count == 1) {
                        $('#wareHoseNameOut').val(item.warID);
                        //$('#wareHoseOut').val(item.warID);
                    }
                });
                layui.form.render("select");
            }
        });

        //自动获取经办人的下拉框
        $.ajax({
            url: '/allocationManager/searchEmployeesJin.action',
            dataType: 'json',
            data: {'state': 0},	//查询状态为正常的所有机构类型
            type: 'post',
            success: function (data) {
                var count = 0;
                $.each(data, function (index, item) {
                    count++;
                    $('#selectOperator').append(new Option(item.empName, item.empNo));// 下拉菜单里添加元素
                    if (count == 1) {
                        $('#selectOperator').val(item.empNo);
                    }
                });
                layui.form.render("select");
            }
        });

    });

    //创建全局变量保存子弹窗传的参
    var tableData=[];
    //第一次渲染没有数据
    saledCom1(tableData);
    //添值方法(与子弹窗一致)
    function saledCom(checkData){
        // var checkData= table.checkStatus('comsearch'); //获取选中行
        if(tableData.length > 0){//判断全局数组是否有数据
            for(var i = 0; i < checkData.length; i++){//循环选中每条的数据
                var states = false;//定义重复状态
                for(var y = 0; y < tableData.length; y++){//循环全局数组数据
                    if(checkData[i].commodity.comId == tableData[y].commodity.comId){
                        states = true;//有重复改变重复状态为真
                        //有重复值数量＋1
                        tableData[y].duo1=Number(tableData[y].duo1)+1;
                    }
                }
                if(!states){//判断不重复则将选中的数据插入全局数组中
                    tableData.push(checkData[i]);
                }
            }

        }else{
            tableData=checkData;
        }
        saledCom1(tableData)
    };

    // 数据表格
    function saledCom1(tableData) {
        //console.log(tableData)
        layui.use('table', function () {
            var table = layui.table,
                util=layui.util;
            table.render({
                elem: '#test'
                ,data:tableData
                ,height:210
                ,id:"saleTable"
                ,totalRow: true //开启合计行
                ,cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                ,cols: [[ //表头
                    {type:'checkbox', fixed: 'left'}
                    ,{templet: '<div>{{d.commodity.comId}}</div>', width: 100, title: '商品编号', totalRowText: '合计'}
                    ,{templet: '<div>{{d.commodity.comName}}</div>', width: 220, title: '商品名称'}
                    ,{templet: '<div>{{d.commodity.comUnit}}</div>', width:80, title: '单位', sort: true}
                    ,{templet: '<div>{{d.commodity.comProduct}}</div>', width:100, title: '产品规格'}
                    ,{templet: '<div>{{d.commodity.comApproval}}</div>', width: 100, title: '批准文号'}
                    /*,{field:'experience', width:100 ,title: '产品批号', sort: true}*/
                   /* ,{templet: '<div>{{d.commodity.duo2}}</div>', width:140 , title: '生产日期', sort: true}
                    ,{templet: '<div>{{d.commodity.duo4}}</div>', width:140 , title: '有效期至'}*/
                    ,{field:'duo5', width:80, title: '单价', sort: true}
                    ,{field: 'duo1', width:80, title: '数量',edit: 'text', sort: true,totalRow: true}
                    ,{field:'duo', width:100, title: '小计', sort: true,totalRow: true,templet:function (d) {
                            return Number(d.duo5)*Number(d.duo1);
                        }}
                    ,{templet: '<div>{{d.commodity.manufacturer.manName}}</div>', width:160, title: '生产厂商', sort: true}
                    ,{templet: '<div>{{d.commodity.comPrice}}</div>', width:100, title: '预设售价', sort: true}
                   /* ,{field:'wealth', width:137, title: '售价总额', sort: true}*/
                    /*, {field: 'comQuality', title: '保质期', width: 120
                        , templet:"<div>{{layui.util.toDataString(d.comQuality,'yyyy年MM月dd日 HH:mm:ss')}}</div>"
                    }*/
                ]]
                ,toolbar: false
                ,page:true
                ,done:function (obj) {
                    var onwanceTotal=0;//统计结算后余额
                    layui.each(obj.data,function(index,d){
                        onwanceTotal+=Number(d.duo5)*Number(d.duo1)
                    })
                    //修改 结算后余额 统计单元格文本
                    this.elem.next().find('.layui-table-total td[data-field="duo"] .layui-table-cell').text(onwanceTotal)
                    //动态获取应付金额
                    $("#amountPayableNumber ").text(onwanceTotal)
                    //动态获取实付金额
                     $("#netMoneyNumber").text(onwanceTotal)
                    //当表格有数据 回调将合计行小数点去除
                   if(tableData.length>0){
                       var a = $(".layui-table-total div:eq(9)").html();
                       a = a.substr(0,a.indexOf("."));
                       //动态获取数量的总计
                       //$("#stock_11").text(a)
                       $(".layui-table-total div:eq(9)").html(a);
                       }
                }
            });

            //监听单元格编辑
            table.on('edit(saleTable)', function(obj){
                var value = obj.value //得到修改后的值
                    ,data = obj.data //得到所在行所有键值
                    ,field = obj.field; //得到字段
                console.log("hello")
                layer.msg('[ID: '+ data.id +'] ' + field + ' 字段更改为：'+ value);
                console.log(field)
            });
            if(tableData.length>0){
                //执行重载
                table.reload('saleTable', {
                    data:tableData
                });
            }

        });
    }

    //当点击保存的时候
    $('#save').click(function () {
        layui.use(['table', 'layer'], function () {
            var table = layui.table;
            var layer = layui.layer;
            //获得数据表格选择的数据
            var checkData = table.checkStatus('saleTable');
            //判断选择的长度
            if (checkData.data.length > 0) {//长度 >0 说明选择了数据
                //封装数据[供货商、收货仓库、进货日期、经办人、单号、备注]
                var supplier = $('#supplier').val();
                var wareHoseNameOut = $('#wareHoseNameOut').val();
                var date = $('#date').val();
                var selectOperator = $('#selectOperator').val();
                var odd = $('#odd').text();
                var remarks = $('#remarks').val();
                //window.alert(odd);
                $.ajax({
                    url: '/merchBillManager/addReceiptsMessage.action',
                    type: 'post',
                    data: {
                        "recOdd": odd,
                        "recEmployeeNo": selectOperator,
                        "redDepotNo": wareHoseNameOut,
                        "recDate":date,
                        "duo1":supplier,
                        "recRemark": remarks
                    }
                    ,success: function (data) {
                        if (data == "success") {
                            var b = JSON.stringify(checkData.data);
                            $.ajax({
                                url: '/merchBillManager/addReceiptsDetailedMessage.action',
                                contentType: "application/json;charset=UTF-8",
                                type: 'post',
                                //dataType: 'json',
                                data: b
                                , success: function (data1) {
                                    console.log(data1);
                                    if (data1 == "success") {
                                        tableData = [];
                                        saledCom1(tableData);
                                        layer.msg('保存成功');
                                        location.reload();
                                    }
                                }
                            });

                        }
                    }
                });
            } else {//长度==0 说明没有选择数据
                layer.msg('请至少选择一条数据', {
                    time: 5000, //20s后自动关闭
                    btn: ['明白了', '好的']
                });
            }
        });
    });
</script>
</div>
</body>
</html>