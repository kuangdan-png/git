<!DOCTYPE html>
<!--
描述：该页面为warehouseBody仓库管理主体页面，关联warehouse.html
制作人：匡佩
完成时间：2019-11-22
-->
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>warehouseBody仓库管理主体</title>
    <link rel="stylesheet" href="layui/css/layui.css?t=1573457678857" media="all">
    <style>
        body{margin-top: -10px;}
        /*表单样式*/
        .aaa{width: 150px;height: 20px; }
        table tr td{padding-top:10px;}
        /*自定义layer.tab的skin皮肤颜色*/
        body .demo-class .layui-layer-title{background: #1e1e19; color:#fff; border: none;}
        body .demo-class .layui-layer-btn{border-top:1px solid #E9E7E7}
        body .demo-class .layui-layer-btn a{background:#333;}
        body .demo-class .layui-layer-btn .layui-layer-btn1{background:#999;}
        /*新增表单按钮居中*/
        .but{padding-left: 65px}
    </style>
</head>
<body>
<div id="button" style="display: none;">
    <!--<button id="insert"  type="button" class="layui-icon " style="margin:2px 0 0 30px;background-color: #88A3D4;">增加</button>-->
    <button id="insert" type="button" lay-event="add" class="layui-btn layui-btn-normal" style="background-color: #88A3D4; "><i class="layui-icon layui-icon-add-circle"></i>添加</button>
    <button id="update" type="button" lay-event="update" class="layui-btn layui-btn-normal" style="background-color: #88A3D4; "><i class="layui-icon layui-icon-edit"></i>修改</button>
    <button id="delete" type="button" lay-event="delete" class="layui-btn layui-btn-normal" style="background-color: #88A3D4; "><i class="layui-icon layui-icon-close"></i>删除</button>
</div>
<table class="layui-hide" id="demo" lay-filter="test" lay-data="{id:'idTest'}">
</table>
<!-- 选择角色的按钮 -->
<div class="layui-row" id="popSearchRoleTest" style="display: none">
    <div class="layui-col-md11">
        <form class="layui-form" lay-filter="formTestFilter2121" id="form">
            <table style="margin-left: 30px" id="table_manage">
                <tr>
                    <td>仓库编号：</td>
                    <td><input type="text" name="warID" class="aaa" id="aaa" disabled="true"></td>
                </tr>
                <tr>
                    <td>仓库名称：</td>
                    <td><input type="text" name="warName" placeholder="请输入仓库名称" class="aaa"></td>
                </tr>
                <tr>
                    <td>负责人：</td>
                    <td><!--<input type="text" name="employeesNo" placeholder="请输入负责人名称" class="aaa">-->
                        <select lay-filter="business" id="xl" name="employeesNo" class="aaa" lay-ignore>
                            <option value="" >请选择负责人</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>联系电话：</td>
                    <td><input type="text" name="warPhone" placeholder="请输入联系电话" class="aaa"></td>
                </tr>
                <tr>
                    <td style="display: none">仓库地址：</td>
                    <td style="display: none"><input type="text" name="warAddressNo" placeholder="请输入仓库地址编号" class="aaa"></td>
                </tr>
                <tr>
                    <td style="display: none">仓库地址：</td>
                    <td style="display: none"><input type="text" name="warAddress" placeholder="请输入仓库地址" class="aaa layui-form"></td>
                </tr>
                <tr>
                    <td>请选择省：</td>
                    <td>
                        <select name="proID" id="proName" lay-ignore class="aaa province-selector" lay-filter="proName">
                            <option value="" >省</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>请选择市：</td>
                    <td>
                        <select  name="citID" id="citName" lay-ignore class="aaa province-selector" lay-filter="citName">
                            <option value="" >市</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>请选择区：</td>
                    <td>
                        <select name="disID" id="disName" lay-ignore class="aaa province-selector" lay-filter="disName">
                            <option value="" >区/县</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>默认仓库：</td>
                    <td><input type="checkbox" name="warDefault" class="aaa" lay-skin="primary" value="1" ></td>
                </tr>
                <tr>
                    <td>仓库状态：</td>
                    <td><input type="checkbox" name="warForbidNo" class="aaa" lay-skin="primary" value="1"><span style="color: red;font-size: 12px">是否禁用</span></td>
                </tr>
                <tr>
                    <td>库存总数量：</td>
                    <td><input type="text" name="repNumber" class="aaa"  placeholder="请输入库存总数量" ></td>
                </tr>
                <tr>
                    <td>库存总值：</td>
                    <td><input type="text" name="warTotalValue" placeholder="请输入库存总值" class="aaa"></td>
                </tr>
                <tr>
                    <td>当前库存：</td>
                    <td><input type="text" name="warCurrent" placeholder="请输入当前库存" class="aaa"></td>
                </tr>
                <tr>
                    <td>最低库存：</td>
                    <td><input type="text" name="warLowest" placeholder="请输入最低库存" class="aaa"></td>
                </tr>
                <tr>
                    <td>备注：</td>
                    <td><textarea placeholder="请输入内容" class="layui-textarea" name="warComment"></textarea></td>
                </tr>
                <tr></tr>
                <tr>
                    <td class="but"> <button type="submit" lay-submit lay-filter="*" id="LAY-component-form-getval"	class="layui-btn layui-btn-sm layui-btn-radius">提交</button></td>
                    <td class="but"> <button type="reset" 	class="layui-btn layui-btn-sm layui-btn-radius">重置</button></td>
                </tr>
            </table>
        </form>
    </div>
</div>
<script src="layui/layui.all.js?t=1573457678857"></script>
<script src="layui/layui.js?t=1573457678857"></script>
<script>
    layui.config({
        version: '1573457678857' //为了更新 js 缓存，可忽略
    });

    layui.use(['laydate','table','element','form','layer'], function(){
        var table = layui.table //表格
            ,$=layui.$
            ,element = layui.element //元素操作
            , laypage = layui.laypage;//分页
        var form = layui.form;
        var layer = layui.layer;

        //监听Tab切换
        element.on('tab(demo)', function(data){
            layer.tips('切换了 '+ data.index +'：'+ this.innerHTML, this, {
                tips: 1
            });
        });
        //执行一个 table 实例
        table.render({
            elem: '#demo'
            ,height: 540//表单的高
            ,width:1168//表单的宽
            ,shade : 0//不显示遮罩
            ,id: 'idTest'
            ,url: '/warehouseManager/searchwarehousemapList.action' //数据接口
            ,title: '仓库表'
            ,page: true //开启分页
            ,limits: [10,20,50]  //每页条数的选择项，默认：[10,20,30,40,50,60,70,80,90]。
            ,limit: 10 //每页默认显示的数量
            /*,method:'post'  //提交方式*/
            ,skin: 'line ' //表格风格 line （行边框风格）row （列边框风格）nob （无边框风格）
            ,toolbar: '#button' //开启工具栏，此处显示默认图标，可以自定义模板，详见文档true/default
            ,totalRow: true //开启合计行
            ,cols: [[ //表头
                {type: 'checkbox', fixed: 'left'}//LAY_CHECKED:true默认单选框选中
                ,{field: 'warID', title: '仓库编号', width:120,  align:'center',sort: true}//sort: true排序
                ,{field: 'warName', title: '仓库名称', align:'center', width: 90}
                ,{field: 'duo1', title: '负责人', align:'center', width: 90}
                ,{field: 'warPhone', title: '联系电话',  align:'center',width:110}
                ,{field: 'warAddress', title: '仓库地址', width: 200,  align:'center'}// totalRow: true合计
                ,{field: 'warDefault', title: '默认仓库',  align:'center', width:100,templet:function(row){
                        var html = "<input type='checkbox' lay-skin='primary' lay-filter='checkboxIsSelected' table-index='"+row.LAY_TABLE_INDEX+"' class='checkboxIsSelected' value='1' ";
                        if(row.warDefault == 1){
                            html += " checked ";
                        }
                        html += ">";
                        return html;
                    }}
                ,{field: 'warForbidNo', title: '禁用仓库', align:'center', width: 100,templet:function(row){
                        var html = "<input type='checkbox' lay-skin='primary' lay-filter='checkboxIsSelected' table-index='"+row.LAY_TABLE_INDEX+"' class='checkboxIsSelected' value='1' ";
                        if(row.warForbidNo == 1){
                            html += " checked ";
                        }
                        html += ">";
                        return html;
                    }}
                ,{field: 'repNumber', title: '库存总数量', align:'center', width: 150,sort: true,totalRow: true}
                ,{field: 'warTotalValue', title: '库存总值', align:'center', width: 150,sort: true,totalRow: true}
                ,{field: 'warCurrent', title: '当前库存', align:'center', width: 150,sort: true,totalRow: true}
                ,{field: 'warLowest', title: '最低库存', align:'center', width: 150,sort: true,totalRow: true}
                ,{field: 'warComment',  align:'center',title: '备注', width: 180}
               /* ,{fixed: 'right', width: 165, align:'center', toolbar: '#barDemo'}*/
            ]],parseData: function(res, curr, count){ //res 即为原始返回的数据 //curr得到当前页码//count得到数据总量
                return {
                    "code": res.status, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "count": res.count, //解析数据长度
                    "data": res.row //解析数据列表
                };
                }, done: function (obj) {
                layer.closeAll();
                form.on('checkbox(checkboxIsSelected)', function (data) {
                    var _index = $(data.elem).attr('table-index') || 0;
                    if (data.elem.checked) {
                        obj.data[_index].warDefault = data.value;
                    } else {
                        obj.data[_index].warDefault = 2;
                    }
                    if (data.elem.checked) {
                        obj.data[_index].warForbidNo = data.value;
                    } else {
                        obj.data[_index].warForbidNo = 2;
                    }
                });
                var supplierList = table.cache.js_table_reource_invite_supplier_index_table;
            }

        });
        //仓库负责人
        $.ajax({
            type:"POST",
            url:"/warehouseManager/searchwarehouseempName.action",  //从数据库查询返回的是个list
            dataType: "json",
            success: function (checkStatus) {
               // alert(JSON.stringify(checkStatus));
                $.each(checkStatus,function(index,dataVa){
                    $('#xl').append(new Option(dataVa.empName,dataVa.empNo));//往下拉菜单里添加元素
                });
                form.render();//菜单渲染 把内容加载进去
            }
        });

        //监听头工具栏事件
        table.on('toolbar(test)', function(obj){
            var checkStatus = table.checkStatus(obj.config.id)
                ,data = checkStatus.data; //获取选中的数据
            switch(obj.event){
                case 'add':
                    /*layer.msg('添加');*/
                    $.ajax({
                        type:"POST",
                        url:'/warehouseManager/warehouseAllprovince.action',  //从数据库查询返回的是个list
                        dataType: "json",
                        success: function (data) {
                            //window.alert(JSON.stringify(data));
                            $.each(data,function(index,item){
                                $('#proName').append(new Option(item.proName,item.proId));//往下拉菜单里添加元素
                            });
                            form.render();
                        }
                    });
                    $("#proName").change(function () {
                        $("#citName").html("");
                        $("#disName").html("");
                        var checkred=JSON.stringify($("#proName option:selected").val());
                        //alert(checkred);
                        // var aa=JSON.stringify($("#proName").val());
                        //alert(aa);
                        $.ajax({
                            type:"POST",
                            url:'/warehouseManager/warehouseAllCity.action?processId='+checkred,  //从数据库查询返回的是个list
                            dataType: "json",
                            success: function (data) {
                                $.each(data,function(index,item){
                                    $('#citName').append(new Option(item.citName,item.citId));//往下拉菜单里添加元素
                                });
                                form.render();
                            }
                        })
                    });
                    $("#citName").change(function () {
                        $("#disName").html("");
                        var checkrede=$("#citName option:selected").val();
                        //alert(checkrede);
                        //var bb=$("#citName").val();
                        //alert(bb);
                        $.ajax({
                            type:"POST",
                            url:'/warehouseManager/warehouseAllArea.action?cityId='+checkrede,  //从数据库查询返回的是个list
                            dataType: "json",
                            success: function (data1) {
                                $.each(data1,function(index,item){
                                    $('#disName').append(new Option(item.disName,item.disId));//往下拉菜单里添加元素
                                });
                                form.render();
                            }
                        })

                    });
                    //编号自增
                    $.ajax({
                        type:"post",
                        url:"/warehouseManager/searchwarehouseIdMax.action",

                        success: function (data2) {
                            //window.alert(data2);
                            var warId= $("#aaa");
                            warId.val(data2)
                        }
                    });
                    layer.open({
                        //layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                        type:1,
                        closeBtn:2,//×的样式
                        title:"新增仓库信息",
                        shade : 0,//不显示遮罩
                        area: ['40%','93%'],//增加框的宽高
                        content:$('#popSearchRoleTest'),// $('#id')
                        skin:'demo-class'//自定义样式风格

                    });
                    layer.close(//当单击新增按钮表单数据清空
                        $('#form')[0].reset()
                    );
                    form.on('submit(*)', function (data) {
                        //var dataValue = data.field;//当前容器的全部表单字段，名值对形式：{name: value}
                        data = form.val('formTestFilter2121');
                        var dataVa=JSON.stringify(data);
                        //alert(JSON.stringify(dataVa));
                            var citId=$("#citName option:selected").val();
                            var proId=$("#proName option:selected").val();
                            var disId=$("#disName option:selected").val();
                        $.ajax({

                            type: "post"//请求提交方式,
                            , url: "/warehouseManager/warehouseInsert.action?proId="+proId+"&citId="+citId+"&disId="+disId
                            , data:dataVa
                            ,async: false
                            , contentType:"application/json;charset=UTF-8"
                            , success:function (checkStatus) {
                                layer.close(index);//关闭窗口
                                table.reload('idTest');//刷新，更新数据
                                form.render();
                            }});
                            /*layer.close(//当单击新增按钮表单数据清空
                                $('#proName')[0].reset(),
                                $('#citName')[0].reset(),
                                $('#disName')[0].reset()
                            );*/
                        location.reload();
                        return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
                    },function(data) {//回调函数
                    //alert(JSON.stringify(data));
                }
                    );
                    break;
                case 'update':

                    if(data.length === 0){
                        layer.msg('请选择一行');
                    } else if(data.length > 1){
                        layer.msg('只能同时编辑一个');
                    } else {
                       $.ajax({
                            type:"POST",
                            url:'/warehouseManager/warehouseAllprovince.action',  //从数据库查询返回的是个list
                            dataType: "json",
                            success: function (data3) {
                                //window.alert("fghj");
                                $.each(data3,function(index,item){
                                    $('#proName').append(new Option(item.proName,item.proId));//往下拉菜单里添加元素
                                });
                                //form.render();
                                //var checkred=JSON.stringify($("#proName option:selected").val());
                                //alert(checkred);
                                // var aa=JSON.stringify($("#proName").val());
                                //alert(aa);
                                var checkred=JSON.stringify(data[0].proNo);
                                //alert(checkred);
                                $("#proName").val(data[0].proNo);
                                $.ajax({
                                    type:"POST",
                                    url:'/warehouseManager/warehouseAllCity.action?processId='+checkred,  //从数据库查询返回的是个list
                                    dataType: "json",
                                    success: function (data1) {
                                        $.each(data1,function(index1,item1){
                                            $('#citName').append(new Option(item1.citName,item1.citId));//往下拉菜单里添加元素
                                        })
                                        //form.render();
                                        $("#citName").val(data[0].citNo);
                                        var checkrede2=$("#citName option:selected").val();
                                        //alert(checkrede);
                                        //var bb=$("#citName").val();
                                        //alert(bb);
                                        $.ajax({
                                            type:"POST",
                                            url:'/warehouseManager/warehouseAllArea.action?cityId='+checkrede2,  //从数据库查询返回的是个list
                                            dataType: "json",
                                            success: function (data2) {
                                                $.each(data2,function(index2,item2){
                                                    $('#disName').append(new Option(item2.disName,item2.disId));//往下拉菜单里添加元素
                                                });
                                                //form.render();
                                                $("#disName").val(data[0].disNo);
                                            }
                                        })

                                    }
                                });
                                 form.render();
                            }
                        });
                        //$("#proName").html("")
                        /*$("#citName").val("")
                        $('#disName option:selected').remove()*/
                        form.render();

                        $.ajax({
                            type:"POST",
                            url:'/warehouseManager/warehouseAllprovince.action',  //从数据库查询返回的是个list
                            dataType: "json",
                            success: function (data) {
                                //window.alert(JSON.stringify(data));
                                $("#proName").change(function () {
                                    $("#citName").html("");
                                    $("#disName").html("");
                                $.each(data,function(index,item){
                                    $('#proName').append(new Option(item.proName,item.proId));//往下拉菜单里添加元素
                                });
                                });
                            }
                        });
                        $("#proName").change(function () {
                            $("#citName").html("");
                            $("#disName").html("");
                            var checkred=JSON.stringify($("#proName option:selected").val());
                            //alert(checkred);
                            // var aa=JSON.stringify($("#proName").val());
                            //alert(aa);
                            $.ajax({
                                type:"POST",
                                url:'/warehouseManager/warehouseAllCity.action?processId='+checkred,  //从数据库查询返回的是个list
                                dataType: "json",
                                success: function (data) {
                                    $.each(data,function(index,item){
                                        $('#citName').append(new Option(item.citName,item.citId));//往下拉菜单里添加元素
                                    });
                                }
                            })
                        });
                        $("#citName").change(function () {
                            $("#disName").html("");
                            var checkrede=$("#citName option:selected").val();
                            //alert(checkrede);
                            //var bb=$("#citName").val();
                            //alert(bb);
                            $.ajax({
                                type:"POST",
                                url:'/warehouseManager/warehouseAllArea.action?cityId='+checkrede,  //从数据库查询返回的是个list
                                dataType: "json",
                                success: function (data1) {
                                    $.each(data1,function(index,item){
                                        $('#disName').append(new Option(item.disName,item.disId));//往下拉菜单里添加元素
                                    });
                                }
                            })

                        });
                        layer.open({
                            //layer提供了5种层类型。可传入的值有：0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                            type:1,
                            closeBtn:2,//×的样式
                            title:"编辑仓库信息",
                            shade : 0,//不显示遮罩
                            area: ['40%','93%'],//增加框的宽高
                            content:$('#popSearchRoleTest'),// $('#id')
                            skin:'demo-class',//自定义样式风格
                            success: function(layero, index){//JQ函数
                                $('#popSearchRoleTest').css({"display": "block"});
                                form.on('submit(*)', function (data) {
                                    var citId=$("#citName option:selected").val();
                                    var proId=$("#proName option:selected").val();
                                    var disId=$("#disName option:selected").val();
                                    data = form.val('formTestFilter2121');
                                    var dataVa=JSON.stringify(data);
                                    //alert(JSON.stringify(data));
                                    $.ajax({
                                        type: "post"//请求提交方式,
                                        , url: "/warehouseManager/warehouseUpdate.action?proId="+proId+"&citId="+citId+"&disId="+disId
                                        , data:dataVa
                                        , contentType:"application/json;charset=UTF-8"
                                        , success:function (checkStatus) {
                                            layer.close(index);//关闭窗口
                                            table.reload('idTest');//刷新，更新数据
                                            //window.alert('编辑成功 ');
                                            form.render();
                                        }
                                    });
                                    /*layer.close(//当单击新增按钮表单数据清空
                                        $('#proName')[0].reset(),
                                        $('#citName')[0].reset(),
                                        $('#disName')[0].reset()
                                    );*/
                                    return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
                                });
                            }
                        });
                       /* console.log(checkStatus.data[0]);
                        console.log(checkStatus.data[0].proNo);
                        console.log(checkStatus.data[0].citNo);
                        console.log(checkStatus.data[0].disNo);*/
                        //表单赋值：为编辑中的表单添加数据库中的数据
                        form.val('formTestFilter2121', {
                            "warID": checkStatus.data[0].warID
                            , "warName": checkStatus.data[0].warName
                            , "employeesNo": checkStatus.data[0].employeesNo
                            , "warPhone": checkStatus.data[0].warPhone
                            /*, "proID": checkStatus.data[0].proID
                            , "citID": checkStatus.data[0].citID
                            , "disID": checkStatus.data[0].disID*/
                            ,"warAddressNo": checkStatus.data[0].warAddressNo
                            , "warAddress": checkStatus.data[0].warAddress
                            , "warDefault": checkStatus.data[0].warDefault
                            , "warForbidNo": checkStatus.data[0].warForbidNo
                            , "warComment": checkStatus.data[0].warComment
                            , "repNumber": checkStatus.data[0].repNumber
                            , "warTotalValue": checkStatus.data[0].warTotalValue
                            , "warCurrent": checkStatus.data[0].warCurrent
                            , "warLowest": checkStatus.data[0].warLowest
                        });
                        //table.reload();
                        form.render();
                    }

                    break;
                case 'delete':
                    if(data.length === 0){
                        layer.msg('请选择一行');
                    } else {
                        layer.open({
                            content: '是否确认删除！',
                            yes: function(index, layero){
                                var checkStatus = table.checkStatus('idTest');
                                //alert(JSON.stringify(checkStatus.data[0].warID));
                                //定义一次性删除多条数据
                                var deleteNo="";
                                for(var i=0;data.length>i;i++) {
                                    var dataRowObj = checkStatus.data[i];
                                    var bookNostr = dataRowObj.warID;
                                    deleteNo += bookNostr + ",";
                                }
                                deleteNo=deleteNo.substring(0, deleteNo.length-1);//去掉多余的，
                                //console.log(deleteNo);
                                $.post(
                                    '/warehouseManager/warehouseDelete.action' , {warID:deleteNo},
                                    function (checkStatus) {
                                        layer.msg(checkStatus.msg);
                                        layer.close(index);//如果成功关闭窗口
                                        //table.reload('idTest');//刷新表单更新数据
                                        table.reload('idTest', {
                                            where: { //设定异步数据接口的额外参数，任意设
                                                //aaaaaa: 'xxx'
                                                //,bbb: 'yyy'
                                                //…
                                                url:'/warehouseManager/searchwarehousemapList.action'
                                            }
                                            ,page: {
                                                curr: 1 //重新从第 1 页开始
                                            }
                                        }); //只重载数据
                                    });
                                layer.close(index); //如果设定了yes回调，需进行手工关闭
                            }
                        });
                    }

                    break;
            }
        });
    })

</script>


</body>
</html>