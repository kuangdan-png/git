<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="/layui/css/layui.css" media="all">
    <script src="/layui/layui.js"></script>
    <script src="/layui/layui.all.js"></script>
    <script src="/JQuery/jquery-3.4.1.min.js"></script>
    <style>
        #div_All_son_two,#div_All_son_one {
            width: 481px;
            height: 472px;
            margin-top: 5px;
            display: inline-block;
            border: 1px black solid;

        }
        #div_All_son_two{
           float: right;
            margin-right: 5px;
        }
        #div_All_son_one{
            margin-left: 5px;
        }
        #div_All_son_one_p{
            margin-top: 5px;
            margin-left: 15px;
            /*border: 1px solid green;*/
            color: green;
        }
        #div_All_son_one_head{
            margin-top:2px;
            width: 481px;
            height: 72px;
            border: 1px solid green;
        }
        #div_All_son_one_head>p>select{
            border-radius: 10px;
            width: 90px;
            height: 30px;
        }
        #div_All_son_one_head>p{
            margin-top: 15px;
            margin-left: 40px;
        }
        #div_All_son_one_head_text{
            height: 30px;
            border-radius: 10px;
           margin-left: 10px;
        }
        #div_All_son_two_head{
            margin-top:2px;
            width: 481px;
            height: 72px;
            border:1px solid black;
        }
        #div_All_son_two>p{
            margin-top: 4px;
                margin-left: 15px;
            color: green;
        }
        #div_All_son_two_head>p{
            margin-left: 20px;
        }
        #div_All_son_two_body{
            margin-top: 20px;
        }

    </style>
</head>
<body>
<!--最外层div-->
<div id="div_All">

    <!--第二层div-->
    <div id="div_All_son">
        <!--左边大div-->
        <div id="div_All_son_one">

            <p id="div_All_son_one_p">查询商品列表</p>
            <div id="div_All_son_one_head">
                <p>
                    <input type="text" id="div_All_son_one_head_text" placeholder="请输入商品关键字">
                   <button class="layui-btn layui-btn-xs" id="join-product" data-type="getCheckData">加入所选商品(F8)</button>
               </p>
            </div>
            <div id="div_All_son_one_body">
                <table class="layui-hide" id="demo" lay-filter="demo">
                </table>
            </div>
        </div>
        <!--右边大div-->

        <div id="div_All_son_two">
            <p>所选商品</p>
            <div id="div_All_son_two_head">
                <button id="Baocun" type="button" class="layui-btn layui-bg-greenl" style="margin-left: 100px;margin-top: 15px">保存</button>
                <button type="button" class="layui-btn layui-bg-green" style="margin-left: 100px;margin-top: 15px">取消</button>
                <div id="div_All_son_two_body">
                    <table class="layui-hide" id="demo1" lay-filter="tbCommodity"></table>
                </div>
            </div>
        </div>
</div>
</div>
<script>
    //获取父页面选择的客户ID
    var cliID=parent.cliID;
    //获取父页面选择的销售单据
    var oddNum=parent.oddNum;
    //退货数据数组
    var tableData=[];
    //全部变量赋值方法
    function tableLoad(checkData,num){
        //点击 单条添加
        if(num=="one") {
            if(tableData.length > 0){//判断全局数组是否有数据
                var states = false;//定义重复状态
                for(var y = 0; y < tableData.length; y++){//循环全局数组数据
                    if(checkData.data.comId == tableData[y].comId) {
                        states = true;//有重复改变重复状态为真
                        tableData[y].duo1=Number(tableData[y].duo1)+1;
                    }
                }
                if(!states){//判断不重复则将选中的数据插入全局数组中
                    checkData.data.duo1=1;
                    tableData.push(checkData.data);
                }
            } else {//全局数组变量没有数据则直接把选中的数据赋给它
                checkData.data.duo1=1;
                tableData[0] = checkData.data;
            }
            //按钮点击事件添加
        }else{
            if(tableData.length > 0){//判断全局数组是否有数据
                for(var i = 0; i < checkData.data.length; i++){//循环选中每条的数据
                    var states = false;//定义重复状态
                    for(var y = 0; y < tableData.length; y++){//循环全局数组数据
                        if(checkData.data[i].comId == tableData[y].comId){
                            states = true;//有重复改变重复状态为真
                            //有重复值数量＋1
                            tableData[y].duo1=Number(tableData[y].duo1)+1;

                        }
                    }
                    if(!states){//判断不重复则将选中的数据插入全局数组中
                        tableData.push(checkData.data[i]);
                    }
                }
            } else {//全局数组变量没有数据则直接把选中的数据赋给它
                for(var y = 0; y < checkData.data.length; y++){//循环全局数组数据
                    checkData.data[y].duo1=1;
                }
                tableData = checkData.data;
            }
        }
    };
    //退货商品表格(根据客户ID、oddNum、输入框的值模糊查询)
    $.ajax({
        url: "/getReturnCommodityByNameOrId.action",
        type: "post",
        dataType: "json",
        //第一次模糊查询条件为空 根据单据查询商品
        data: {"val":"","cliID":cliID,"oddNum":oddNum},
        success: function (list) {
            if (list != null) {
                //传递参数给数据表格方法
                comTable(list);
                //监控输入框
                $("#div_All_son_one_head_text").bind("input",function () {
                    $.ajax({
                        url: "/getReturnCommodityByNameOrId.action",
                        type: "post",
                        dataType: "json",
                        //将输入框值和仓库id传入查
                        data: {"val":$(this).val(),"cliID":cliID,"oddNum":oddNum},
                        success: function (list) {
                            if (list != null) {
                                //传递参数给数据表格方法
                                comTable(list);
                            }
                        },
                        error: function (data) {
                            console.info(data);
                        }
                    })
                })

            }
        },
        error: function (data) {
            console.info(data);
            layer.msg("此单据可退货数量为0")
        }
    })
    //退货商品表格渲染方法
    function comTable(list) {
        layui.use('table', function () {
            var table = layui.table;
            table.render({
                elem: '#demo'
                //使用layui数据表格的data属性将Ajax调用的后台数据绑定
                , data: list
                , title: '商品列表'
                , height:340
                , cols: [[
                    {type:'checkbox', fixed: 'left'}
                    , {field: 'comId', width: 100,align:'center', title: '商品编号', totalRowText: '合计'}
                    , {field: 'comName', width: 160,align:'center', title: '商品名称'}
                    , {field: 'comSimpleCode', width: 100,align:'center', title: '简码'}
                    , {field: 'comProduct', width: 100,align:'center', title: '规格型号'}
                    ,{field: 'comBarCode', width: 200,align:'center', title: '商品条码'}
                ]]
                , id: 'comsearch'
                , page: true
            });
            //监听行双击事件（双击事件为：rowDouble）
            table.on('rowDouble(demo)', function(obj){
                //为其添加样式
                var flag= true;
                if(flag){
                    flag = false;
                }else{
                    flag = true;
                }
                tableLoad(obj,"one");
                //渲染表格方法
                comchoosedTable(tableData)
            });
            //监听表格复选框选择
            table.on('checkbox(demo)', function(obj){
                //添加样式
                if(obj.checked){
                    obj.tr.addClass('layui-bg-blue');// 添加选中样式
                }else {
                    obj.tr.removeClass('layui-bg-blue');// 移除选中样式
                }
            });
            var $ = layui.$, active = {
                getCheckData: function(){ //获取选中数据
                    var checkStatus = table.checkStatus('comsearch')
                        ,data = checkStatus.data;
                    tableLoad(checkStatus,"more");
                    //渲染表格方法
                    comchoosedTable(tableData)
                }
                /*table.reload('comsearch', {
                })*/
            }
            $('#join-product').on('click', function(){
                var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });
        })
    }
    //所选择的退货商品
    function comchoosedTable(list) {
        layui.use('table', function(){
            var table = layui.table;
            //第二个实例
            table.render({
                elem: '#demo1'
                ,data:list //数据接口
                ,height: 350
                ,id:"tbCommodity"
                ,totalRow: true //开启合计行
                ,cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                ,page:true
                ,cols: [[ //表头
                    {type:'checkbox', fixed: 'left'}
                    , {field: 'comId', width: 100,align:'center', title: '商品编号', totalRowText: '合计'}
                    ,{field: 'duo1', width: 70,align:'center', title: '数量',sort: true,edit: 'text', totalRow: true}
                    , {field: 'comName', width: 100,align:'center', title: '商品名称'}
                    , {field: 'comSimpleCode', width: 100,align:'center', title: '简码'}
                    , {field: 'comProduct', width: 100,align:'center', title: '规格型号'}
                    ,{field: 'comBarCode', width: 200,align:'center', title: '商品条码',}
                ]]
                ,done:function () {
                    //当表格有数据 回调将合计行小数点去除
                    if(tableData.length>0){
                        var a = $(".layui-table-total div:eq(2)").html();
                        a = a.substr(0,a.indexOf("."));
                        $(".layui-table-total div:eq(2)").html(a);
                    }
                }
            });
            //监听单元格编辑
            table.on('edit(tbCommodity)', function(obj){
                var value = obj.value //得到修改后的值
                    ,data = obj.data //得到所在行所有键值
                    ,field = obj.field; //得到字段
                //获取编辑前的值
                var g=0;
                var a="";
                for(var i=0;i<tableData.length;i++){
                    if(tableData[i].comId===data.comId){
                        a = $(".layui-table-body tr[data-index="+i+"] td[data-field='duo1'] .layui-table-cell").html();
                        g=i;
                        break;
                    }
                }
                //判断数据类型
                if(!Number(value)) {
                    //数量为0则在全局变量删除此数据
                    if(value==0){
                        for(var a=0;a<tableData.length;a++){
                            if(data.comId==tableData[a].comId){
                                tableData.splice(a,1);
                                break;
                            }
                        }
                        //一条数据 数量更改为1 则刷新页面
                        if(tableData.length=1){
                            window.location.reload();
                        }else{
                            //重新渲染表格
                            comchoosedTable(tableData);
                        }

                    }else{
                        layer.msg('请输入数字');
                        // 重点 赋值
                        tableData[g].duo1=a;
                        table.reload('tbCommodity', {
                            data:tableData
                        });
                    }
                }else{
                    //异步通过商品id在库存表查询编辑后的数量是否大于库存
                    $.ajax({
                        url: "/IfReturnNumBigRepertory.action",
                        type: "post",
                        dataType: "text",
                        data: {"comId": data.comId, "uPNum": value,"oddNum":oddNum},
                        success: function (list) {
                            if(value>Number(list)){
                                //layer.msg("退货数不能大于购买数");
                                layer.msg('销售量:'+list,{
                                    title:'退货数不能大于购买数'
                                });
                                tableData[g].duo1=a;
                                table.reload('tbCommodity', {
                                    data:tableData
                                });
                            }else{
                                //遍历全局变量
                                for(var i=0;i<tableData.length ;i++){
                                    //改变编辑行在全局变量的数量
                                    if(tableData[i].comId===data.comId){
                                        tableData[i].duo1=value;
                                        //重新渲染表格
                                        comchoosedTable(tableData);
                                    }
                                }
                            }
                        }
                    });
                }
            });
        });
    }
    //保存按钮 将全局变量保存传至父弹窗
    $('#Baocun').on('click',function(){
        parent.saledCom(tableData);
        //关闭当前弹窗
        var index=parent.layer.getFrameIndex(window.name);
        parent.layer.close(index);
    })
</script>
</body>

</html>