<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>采购进货(老商品添加)</title>
    <link rel="stylesheet" href="layui/css/layui.css" media="all">
    <script src="layui/layui.js"></script>
    <script src="layui/layui.all.js"></script>
    <script src="JQuery/jquery-3.4.1.min.js"></script>

    <style>
        /*将表单的信息隐藏，边框，圆角边框*/
       .body-color{display: none;border:1px solid #000; height:485px;width: 898px;background-color:#EBEBEB;border-radius: 2px;}
        /*设置title的字体颜色，边框，字体*/
        body .demo-class .layui-layer-title{color:#35529E;}
        /*左边部分*/
        #addform-left{background-color:#EBEBEB;border:1px solid #9F9F9F;border-radius:2px;width:435px;height:auto;margin:8px 0 0 5px;display:inline-block;}
        #addform-left #lefttop-list{font-size: 13px;width:80px;margin-left:5px;margin-top:-8px;background-color:#fff;}
        #addform-left p{font-size: 12.5px;margin-left: 2px;}
        #addform-left p span{color:red;}
        #addform-left .lefttop-steptwo a{color:red;font-weight: bold;font-size:15px;margin-left:10px;text-decoration: underline;}
        /*搜索框*/
        .lefttop-search{margin-top:10px;}
        .lefttop-search .layui-input{width:120px;height:20px;border-color:#9F9F9F;border-radius:0;display: inline-block;}
        .lefttop-search .layui-btn{height: 25px;line-height: 25px;margin:-3px 0 0 10px;font-size: 12px;border-radius: 50px;}

        /*左边的选项卡部分*/
        .layui-tab{width:433px;}
        .layui-tab .layui-tab-title li{font-size: 12px;}
        /*右边部分*/
        #addform-right{background-color:#EBEBEB;border:1px solid #9F9F9F;border-radius:2px;width:435px;height:auto;margin:8px 5px 0 0;clear:both;float:right;display:inline-block;}
        #addform-right #righttop-list{font-size: 13px;width:55px;margin-left:5px;margin-top:-8px;background-color: #fff;}
        #addform-right .layui-btn{height: 22px;line-height: 22px;margin:3px 0 11px 20px;font-size: 12px;border-radius: 50px;}
    </style>
</head>
<body>
    <!-- 左边部分-->
    <div id="addform-left">
        <p id="lefttop-list">查询商品列表</p>
        <p>
            <span>步骤一：</span>请输入商品编号或名称查询商品，查询到商品后添加到右边所选商品
        </p>
        <p class="lefttop-steptwo">
            <span>步骤二：</span>如果是新的商品项目，即商品名称不在列表中，请点<a href="#" id="addNew-shop">添加新商品</a>
        </p>
        <p class="lefttop-search">
            输入商品编号或名称查询商品：
            <input type="text" name="title" id="searchText" required lay-verify="required" autocomplete="off" class="layui-input">
            <button type="button" class="layui-btn layui-btn-xs" id="join-product"  data-type="getCheckData">加入所选商品(F8)</button>
        </p>
        <!--选项卡-->
        <div class="layui-tab layui-tab-card">
            <ul class="layui-tab-title">
                <li class="layui-this">商品清单</li>
                <li>商品列表</li>
                <li>最近进货</li>
            </ul>
            <div class="layui-tab-content" style="height: auto;background-color: #fff;">
                <!--商品清单-->
                <div class="layui-tab-item layui-show" style="overflow:auto;margin: -18px 0 0 -8px;">
                    <table class="layui-hide" id="test" lay-filter="test"></table>
                </div>
                <!--商品列表-->
                <div class="layui-tab-item" >
                    <!--左边树形-->
                    <div id="test9" class="demo-tree demo-tree-box"
                         style="background-color: #fff;display: inline-block;border:1px solid grey;margin:-8px;width: 150px; height:385px; overflow: scroll;"></div>
                    <!--右边表格-->
                    <div style="background-color: #fff;float: right; clear: none;margin:-18px -8px 0 0 ;">
                        <table class="layui-hide" id="test-lefttwo" lay-filter="test"></table>
                    </div>
                </div>
                <!--最近进货-->
                <div class="layui-tab-item" style="background-color: #fff;margin: -18px 0 0 -8px;">
                    <table class="layui-hide" id="test-recently"></table>
                </div>
            </div>
        </div>
    </div>

    <!-- 右边部分-->
    <div id="addform-right">
        <p id="righttop-list">所选商品</p>
        <div style="margin-top: -5px;background-color: #fff;height:455px;">
            <table class="layui-hide" id="test-right" lay-filter="test-right"></table>
        </div>
        <!--按钮-->
        <button id="delete" type="button" class="layui-btn layui-btn-xs" data-type="getCheckData">删除(Del)</button>
        <button id="right" type="button" class="layui-btn layui-btn-xs">确定(F5)</button>
        <button type="button" class="layui-btn layui-btn-xs" id="cancle">取消(F4)</button>
    </div>

<script>

    //添加单击事件【将增加商品添加至添加新商品中】
    $('#addNew-shop').on('click',function () {
        layer.open({
            type: 2,
            title:'增加商品'
            ,content:'newAddition.html'
            ,area:['495px','560px']
            ,skin: 'demo-class'
            ,shade: 0
            ,moveOut:true
        });
    })


    //定义全局数组变量保存右边被选中数据表格数据
    var tableData=[];
    //全部变量赋值方法
    function tableLoad(checkData,num){
        //点击 单条添加
        if(num=="one") {
            if(tableData.length > 0){//判断全局数组是否有数据
                var states = false;//定义重复状态
                for(var y = 0; y < tableData.length; y++){//循环全局数组数据
                    if(checkData.data.commodity.comId == tableData[y].commodity.comId){
                        states = true;//有重复改变重复状态为真
                        //有重复值数量＋1
                        tableData[y].duo1=Number(tableData[y].duo1)+1;
                    }
                }
                if(!states){//判断不重复则将选中的数据插入全局数组中
                    checkData.data.duo1 = 1;
                    tableData.push(checkData.data);
                }
            } else {//全局数组变量没有数据则直接把选中的数据赋给它
                checkData.data.duo1 = 1;
                tableData[0] = checkData.data;
            }
            //按钮点击事件添加
        }else{
            if(tableData.length > 0){//判断全局数组是否有数据
                for(var i = 0; i < checkData.data.length; i++){//循环选中每条的数据
                    var states = false;//定义重复状态
                    for(var y = 0; y < tableData.length; y++){//循环全局数组数据
                        if(checkData.data[i].commodity.comId == tableData[y].commodity.comId){
                            states = true;//有重复改变重复状态为真
                            //有重复值数量＋1
                            tableData[y].duo1=Number(tableData[y].duo1)+1;
                        }
                    }
                    if(!states){//判断不重复则将选中的数据插入全局数组中
                        checkData.data[i].duo1=1;
                        tableData.push(checkData.data[i]);
                    }
                }
            } else {//全局数组变量没有数据则直接把选中的数据赋给它
                //初始化值
                for (var b = 0; b < checkData.data.length; b++) {
                    checkData.data[b].duo1 = 1;
                }
                tableData = checkData.data;
            }
        }
    }
    var supplierNo = parent.PartitionId;
    // window.alert(supplierNo);

    //搜索框[左边列表(商品清单)]
    $.ajax({
        url: "/merchBillManager/searchMerchBillList.action",
        type: "post",
        dataType: "json",
        //第一次模糊查询条件为空 查询全部商品
        data: {"repComId":"","repId":supplierNo},
        success: function (list) {
            console.log(list);
            if (list != null) {
                //传递参数给数据表格方法
                comTable(list);
                //监控输入框
                $("#searchText").bind("input",function () {
                    $.ajax({
                        url: "/merchBillManager/searchMerchBillList.action", //数据接口
                        type: "post",
                        dataType: "json",
                        //将输入框值传入后天查询
                        data: {"repComId":$(this).val()},
                        success: function (list) {
                            if (list != null) {
                                //传递参数给数据表格方法
                                comTable(list);
                            }
                        },
                        error: function (data) {
                            console.info(data);
                        }
                    })
                })
            }
        },
        error: function (data) {
            console.info(data);
        }
    });
    //渲染商品清单表格方法
    function comTable(list) {
        //2_1.左边列表(商品清单)
        layui.use('table', function () {
            //window.alert(JSON.stringify(list));
            var table = layui.table;
            table.render({
                elem: '#test'
                //使用layui数据表格的data属性将Ajax调用的后台数据绑定
                , data: list
                , height: 375
                , width:570
                , cellMinWidth: 80
                , page:true
                ,limit:15
                ,limits:[1,15,30,45]
                , cols: [[  //表头
                    {type: 'checkbox', fixed:true} //LAY_CHECKED:true默认单选框选中
                    , {templet: '<div>{{d.commodity.comId}}</div>', width: 100, title: '商品编号', sort: true,fixed:true}
                    , {templet: '<div>{{d.commodity.comName}}</div>', width: 220, title: '商品名称'}
                    , {templet: '<div>{{d.commodity.comUnit}}</div>', title: '单位'}
                    , {templet: '<div>{{d.commodity.comProduct}}</div>', width: 100, title: '规格'}
                    , {field:'duo5', width: 100, title: '参考进价'}
                    , {templet: '<div>{{d.commodity.manufacturer.manName}}</div>', width: 160, title: '生产厂商'}
                 ]]
                , id: 'comsearch'
            })

            //监听行双击事件（双击事件为：rowDouble）
            table.on('rowDouble(test)', function(obj){
                //将双击的行数据做参数 并带区分参数
                tableLoad(obj,"one");
                //渲染表格方法
                comchoosedTable(tableData)
            });
            //监听表格复选框选择
            table.on('checkbox(test)', function(obj){
            });
            var $ = layui.$, active = {
                getCheckData: function(){ //获取选中数据
                    var checkStatus = table.checkStatus('comsearch')
                        ,data = checkStatus.data;
                    //将复选框选中的行数据做参数 并带区分参数
                    tableLoad(checkStatus,"more");
                    //渲染表格方法
                    comchoosedTable(tableData)
                    table.reload('comsearch', {

                    })
                }
            };
            $('#join-product').on('click', function(){
                var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';

            });
        })
    }

    //（2_1）商品列表
    $.ajax({
        type: "POST",
        url: "/merchBillManager/searchCommodityParentType.action",
        success: function(msg){
            //window.alert(JSON.stringify(msg));
            layui.use('tree', function(){
                var tree = layui.tree;
                //渲染
                var inst1 = tree.render({
                    elem: '#test9'  //绑定元素
                    ,data: msg
                    //,edit: ['add', 'update', 'del']
                    //根据树形控件查询数据
                    ,click:function(obj) {
                        layui.use('table', function () {
                            var table = layui.table //表格
                            // 执行一个 table 实例
                            //window.alert(JSON.stringify(obj.data.catId ))
                            table.render({
                                elem: '#test-lefttwo',
                                url: '/merchBillManager/searchCommodityForType.action?comTypeId=' + obj.data.catId //数据接口,
                                , width: 273
                                , height: 376
                                , id:'tableList'
                                , limit:500
                                , cellMinWidth: 80
                                //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                                , cols: [[
                                    {type:'checkbox'} //LAY_CHECKED:true默认单选框选中
                                    , {templet: '<div>{{d.commodity.comId}}</div>', width: 100, title: '商品编号', sort: true}
                                    , {templet: '<div>{{d.commodity.comName}}</div>', width: 220, title: '商品名称'}
                                    , {templet: '<div>{{d.commodity.comUnit}}</div>', title: '单位'}
                                    , {field:'reqCurrent',  title: '库存数'}
                                    , {field: 'duo5', title: '参考进价',}
                                    , {templet: '<div>{{d.commodity.comProduct}}</div>',width: 100, title: '规格'}
                                    , {templet: '<div>{{d.commodity.manufacturer.manName}}</div>',width: 160, title: '生产厂商'}
                                ]],parseData: function (res, curr, count) { //res 即为原始返回的数据 //curr得到当前页码//count得到数据总量
                                    return {
                                        "code": res.status, //解析接口状态
                                        "msg": res.msg, //解析提示文本
                                        "count": res.count, //解析数据长度
                                        "data": res.row //解析数据列表
                                    }
                                }, done: function (obj) {
                                    layer.closeAll();
                                }
                            });
                            //监听行双击事件（双击事件为：rowDouble）
                            table.on('rowDouble(test-lefttwo)', function(obj){
                                //将双击的行数据做参数 并带区分参数
                                tableLoad(obj,"one");
                                //渲染表格方法
                                comchoosedTable(tableData)
                            });
                            //监听表格复选框选择
                            table.on('checkbox(test-lefttwo)', function(obj){

                            });
                            var $ = layui.$, active = {
                                getCheckData: function(){ //获取选中数据
                                    var checkStatus = table.checkStatus('tableList')
                                        ,data = checkStatus.data;
                                    console.log(data);
                                    //将复选框选中的行数据做参数 并带区分参数
                                    tableLoad(checkStatus,"more");
                                    //渲染表格方法
                                    comchoosedTable(tableData)
                                    table.reload('tableList', {
                                    })
                                }
                            };
                            $('#join-product').on('click', function(){
                                var type = $(this).data('type');
                                active[type] ? active[type].call(this) : '';
                            });

                        })
                    }

                });

            });

        }
    });

    //左边列表(最近进货)
    layui.use('table', function(){
        var table = layui.table;

        table.render({
            elem: '#test-recently'
            ,url:'/merchBillManager/searchRecentStockPurList.action'
            ,height:375
            ,width:429
            ,id:'timeList'
            ,cellMinWidth: 80
            ,cols: [[
                {type:'checkbox'} //LAY_CHECKED:true默认单选框选中
                ,{templet:'<div>{{d.commodity.comId}}</div>',width:100, title: '商品编号'}
                ,{templet:'<div>{{d.commodity.comName}}</div>',width:220,  title: '商品名称',sort: true}
                ,{field:'duo5', title: '单价'}
                ,{templet:'<div>{{d.commodity.comUnit}}</div>', title: '单位'}
                ,{templet:'<div>{{d.commodity.comProduct}}</div>',width:100, title: '规格'}
                ,{field:'redredchaseDate',templet:'<div>{{ layui.util.toDateString(d.redredchaseDate,"yyyy-MM-dd HH:mm:ss")}}</div>',width:180,  title: '进货日期'}
            ]], parseData: function (res, curr, count) { //res 即为原始返回的数据 //curr得到当前页码//count得到数据总量
                return {
                    "code": res.status, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "count": res.count, //解析数据长度
                    "data": res.row //解析数据列表
                }
            }
            , done: function (obj) {
                layer.closeAll();
            }
        });

        //监听表格复选框选择
        table.on('rowDouble(test-recently)', function(obj){
            //将双击的行数据做参数 并带区分参数
            tableLoad(obj,"one");
            //渲染表格方法
            comchoosedTable(tableData)
        });

        //监听表格复选框选择
        table.on('checkbox(test-recently)', function(obj){

        });
        var $ = layui.$, active = {
            getCheckData: function(){ //获取选中数据
                var checkStatus = table.checkStatus('timeList')
                    ,data = checkStatus.data;
                /* layer.alert(JSON.stringify(data));*/
                console.log(data);
                //将复选框选中的行数据做参数 并带区分参数
                tableLoad(checkStatus,"more");
                //渲染表格方法
                comchoosedTable(tableData)
                table.reload('timeList', {
                })
            }
        };

        $('#join-product').on('click', function(){
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });

    });

    /*3.右边列表*/
    function comchoosedTable(list) {
        layui.use('table', function(){
            var table = layui.table;
            table.render({
                elem: '#test-right'
                ,data:list
                , height: 452
                ,id:"tbCommodity"
                , totalRow: true //开启合计行
                , toolbar: false
                , page:true
                , limit:15
                , limits:[1,15,30,45]
                , cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                , cols: [[ //表头
                    {type: 'checkbox'} //LAY_CHECKED:true默认单选框选中
                    , {templet: '<div>{{d.commodity.comName}}</div>', width: 220, title: '商品名称', sort: true}
                    , {templet: '<div>{{d.commodity.comUnit}}</div>', title: '单位'}
                    , {field: 'duo5', title: '进价'}
                    , {field: 'duo1', title: '数量', edit: 'text',totalRow: true}
                    , {field:'duo', title: '小计', minWidth: 100,templet:function (d) {
                            return Number(d.duo5)*Number(d.duo1);
                        },totalRow: true} //minWidth：局部定义当前单元格的最小宽度，layui 2.2.1 新增
                    , {field: '', title: '产品批号', sort: true}
                  /*  , {templet: '<div>{{d.commodity.duo2}}</div>', width:140 , title: '生产日期', sort: true}
                    , {templet: '<div>{{d.commodity.duo4}}</div>', width:140 , title: '有效期至'}*/
                    , {templet: '<div>{{d.commodity.comRemarks}}</div>', title: '备注', sort: true}

                ]], parseData: function (res, curr, count) { //res 即为原始返回的数据 //curr得到当前页码//count得到数据总量
                    return {
                        "code": res.status, //解析接口状态
                        "msg": res.msg, //解析提示文本
                        "count": res.count, //解析数据长度
                        "data": res.row //解析数据列表
                    }
                }, done: function (obj) {
                    layer.closeAll();
                    var onwanceTotal=0;//统计结算后余额
                    layui.each(obj.data,function(index,d){
                        onwanceTotal+=Number(d.duo5)*Number(d.duo1)
                    })
                    //修改 结算后余额 统计单元格文本
                    this.elem.next().find('.layui-table-total td[data-field="duo"] .layui-table-cell').text(onwanceTotal)
                   /* $("#shouldNumber").text(onwanceTotal)
                    //当表格有数据 回调将合计行小数点去除
                    if(tableData.length>0){
                        var a = $(".layui-table-total div:eq(4)").html();
                        a = a.substr(0,a.indexOf("."));
                        $("#allNumber").text(a)
                        $(".layui-table-total div:eq(4)").html(a);
                    }*/
                }

            });
            //监听表格复选框选择
            table.on('checkbox(test-right)', function(obj){

            });
            var $ = layui.$, active = {
                getCheckData: function(){ //获取选中数据
                    var checkStatus = table.checkStatus('tbCommodity')
                        ,data = checkStatus.data;
                    //删除选中全局数组变量数据
                    layui.use('layer',function () {
                        layer.confirm('确认要删除吗？', {
                            btn : [ '确定', '取消' ]//按钮
                        }, function(index) {
                            deleteChoosedCom(checkStatus)
                            table.reload('tbCommodity',{data : tableData});
                            layer.close(index);
                        });
                    })

                }
            };
            $('#delete').on('click', function(){
                var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });

            //监听单元格编辑
            table.on('edit(tbCommodity)', function(obj){
                console.log("hello")
                var value = obj.value //得到修改后的值
                    ,data = obj.data //得到所在行所有键值
                    ,field = obj.field; //得到字段
                layer.msg('[ID: '+ data.id +'] ' + field + ' 字段更改为：'+ value);
            });
        });
    }

    //删除方法
    function deleteChoosedCom(checkData) {
        for(var i = 0; i < checkData.data.length; i++){//循环选中每条的数据
            for(var y = 0; y < tableData.length; y++){//循环全局数组数据
                if(checkData.data[i].commodity.comId == tableData[y].commodity.comId){
                    tableData.splice(y,1);
                }
            }
        }
    }

    //确定按钮 将全局变量保存传至父弹窗
    $('#right').on('click',function(){
        //window.alert("dfgh");
        parent.saledCom(tableData);
        //关闭当前弹窗
        var index=parent.layer.getFrameIndex(window.name);
        parent.layer.close(index);
    })
    //取消按钮
    $('#cancle').on('click',function () {
        var index=parent.layer.getFrameIndex(window.name);
        parent.layer.close(index);
    })


</script>
</body>
</html>