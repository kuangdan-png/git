<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="merchbill.crud">
    <!--1、查询所有商品清单信息的集合(包括商品信息) 【商品表、生产厂商表、库存明细表、供货商表】(库存明细编号[supID]、商品编号、名称)-->
    <select id="searchMerchBillList" resultMap="repertorySonMap">
        select man.manId,com.comId,sup.supID,com.comName,com.comPurchase duo5,
        com.comApproval,com.duo1,com.duo5,com.comUnit,com.comProduct,com.comPrice,
        com.comSupplierNo,man.manName
        from commodity com
        inner join manufacturer man
        on com.comManufact = man.manId
        inner join supplier sup
        on com.comSupplierNo = sup.supID
	where 1=1
	<if test="null != repId and repId != ''">
        and supID =#{repId}
    </if>
    <if test="null != repComId and repComId != ''">
        and comId like "%" #{repComId} "%"
    </if>
    <if test="null != repProName and repProName != ''">
        AND comName like "%" #{repProName} "%"
    </if>
    </select>

    <!--3、查询所有最近进货信息的集合(包括商品信息)【单据明细表  商品表 生产厂商】-->
    <select id="searchRecentStockPurList" resultMap="receiptsDetailed">
        select red.redNo,com.comId,com.comName,com.comApproval,com.duo1,com.comPurchase duo5,com.comUnit,com.comProduct,
        com.comPrice,red.redredchaseDate,man.manName
        from commodity com
        inner join receipts_detailed red
        on com.comId = red.redProcutsNo
        inner join manufacturer man
        on com.comManufact = man.manId
        order by red.redredchaseDate desc
        limit 10
    </select>

    <!--4、新增单据明细表-->
    <insert id="insertReceiptsDetailed" parameterType="receiptsDetailed">
        insert into receipts_detailed(redNo,redOdd,redProcutsNo,redName,redUnit,redredduct,
        redPermitNo,redredchaseDate,redPrice,redCount,redManufact,redRecNo)
        values(#{redNo},#{redOdd},#{redProcutsNo},#{redName},#{redUnit},#{redredduct},
        #{redPermitNo},#{redredchaseDate},#{redPrice},#{redCount},#{redManufact},
        #{redRecNo})
    </insert>

    <!--5、新增单据主表信息-->
    <insert id="insertReceiptsInfo" parameterType="receipts">
        insert into receipts (recNo,recOdd,recDocumentTypes,recDate,
        recEmployeeNo,recRemark,recTiaoNumber,recTotalNumber,
        redPutNo,redDepotNo,duo1) values(#{recNo},#{recOdd},#{recDocumentTypes},#{recDate},
        #{recEmployeeNo},#{recRemark},#{recTiaoNumber},#{recTotalNumber},#{redPutNo}
        ,#{redDepotNo},#{duo1})
    </insert>

    <!--6、修改库存入库信息【增加库存数(商品编号)、判断数量多1不为空并且''不为多1 仓库编号】-->
    <update id="updateRepertorySonInInfo" parameterType="receiptsDetailed">
        update repertoryson set reqCurrent=(reqCurrent+#{redCount})
        where repComId=#{redProcutsNo}
        <if test="null != duo1 and '' != duo1">
            and reqWareNo = #{duo1}
        </if>
    </update>

    <!--7、查询是否存在该商品信息在库存中-->
    <select id="searchRepertorySonInfo" parameterType="receiptsDetailed" resultType="String">
        select repId from repertoryson
        inner join warehouse on warID=reqWareNo
        where repComId=#{redProcutsNo} and warID=#{duo1}
    </select>

    <!--8、新增库存明细信息-->
    <insert id="insertRepertorySonInfo" parameterType="repertorySon">
        insert into repertoryson(repId,repComId,
        repProName,reqCurrent,reqWareNo,reqPrice)
        values(#{repId},#{repComId},#{repProName},
        #{duo1},#{reqWareNo},#{reqPrice})
    </insert>

    <!--单据明细表Map-->
    <resultMap id="receiptsDetailed" type="receiptsDetailed">
        <id column="redNo" property="redNo"/>
        <result column="redOdd" property="redOdd"/>
        <result column="redName" property="redName"/>
        <result column="redUnit" property="redUnit"/>
        <result column="redredduct" property="redredduct"/>
        <result column="redPermitNo" property="redPermitNo"/>
        <result column="redDate" property="redDate"/>
        <result column="redValidUntil" property="redValidUntil"/>
        <result column="redPrice" property="redPrice"/>
        <result column="redCount" property="redCount"/>
        <result column="redManufact" property="redManufact"/>
        <result column="redManufactName" property="redManufactName"/>
        <result column="redPreprice" property="redPreprice"/>
        <result column="redTotalPrice" property="redTotalPrice"/>
        <result column="redSupplierNo" property="redSupplierNo"/>
        <result column="redPutNo" property="redPutNo"/>
        <result column="redDepotNo" property="redDepotNo"/>
        <result column="redredchaseDate" property="redredchaseDate"/>
        <result column="redComment" property="redComment"/>
        <result column="redReturnDate" property="redReturnDate"/>
        <result column="redDocumentTypes" property="redDocumentTypes"/>
        <result column="redProductTypeNo" property="redProductTypeNo"/>
        <result column="redProductTypeName" property="redProductTypeName"/>
        <result column="redRecNo" property="redRecNo"/>
        <result column="redZhe" property="redZhe"/>
        <result column="redModel" property="redModel"/>
        <result column="redQuanStock" property="redQuanStock"/>
        <result column="redCountedQuantity" property="redCountedQuantity"/>
        <result column="duo1" property="duo1"/>
        <result column="duo2" property="duo2"/>
        <result column="duo4" property="duo4"/>
        <result column="duo5" property="duo5"/>
        <result column="duo6" property="duo6"/>
        <result column="duo7" property="duo7"/>

        <!--1.单据明细表的商品编号【redProcutsNo】FK 对应 商品表的商品编号【comId】PK  【最近进货】-->
        <!--<result column="redProcutsNo" property="redProcutsNo"/>-->
        <association property="commodity" resultMap="Commodity">
        </association>
    </resultMap>

    <!--库存明细表Map-->
    <resultMap id="repertorySonMap" type="repertorySon">
        <id column="repId" property="repId"/>
        <result column="repProName" property="repProName"/>
        <result column="repNumber" property="repNumber"/>
        <result column="reqTotality" property="reqTotality"/>
        <result column="reqPrice" property="reqPrice"/>
        <result column="reqShouPrice" property="reqShouPrice"/>
        <result column="reqCurrent" property="reqCurrent"/>
        <result column="reqLowest" property="reqLowest"/>
        <result column="reqWareNo" property="reqWareNo"/>
        <result column="duo1" property="duo1"/>
        <result column="duo2" property="duo2"/>
        <result column="duo3" property="duo3"/>
        <result column="duo4" property="duo4"/>
        <result column="duo5" property="duo5"/>
        <!--1.库存明细表的商品编号【repComId】FK 对应 商品表的商品编号【comId】PK  【库存数】-->
        <!--<result column="repComId" property="repComId"/>-->
        <association property="commodity" resultMap="Commodity"/>

        <association property="warehouse" resultMap="warehouseMap"/>
    </resultMap>

    <!--商品表Map-->
    <resultMap id="Commodity" type="commodity">
        <id column="comId" property="comId"/>
        <result column="comName" property="comName"/>
        <result column="comSimpleCode" property="comSimpleCode"/>
        <!--<result column="comTypeId" property="comTypeId"/>-->
        <result column="comGenericName" property="comGenericName"/>
        <result column="comBarCode" property="comBarCode"/>
        <result column="comUnit" property="comUnit"/>
        <result column="comEpherine" property="comEpherine"/>
        <result column="comElectonic" property="comElectonic"/>
        <result column="comProduct" property="comProduct"/>
        <result column="comMedicame" property="comMedicame"/>
        <result column="comRegister" property="comRegister"/>
        <result column="comApproval" property="comApproval"/>
        <result column="comQuality" property="comQuality"/>
        <result column="comState" property="comState"/>
        <result column="comSpecial" property="comSpecial"/>
        <result column="comPurchase" property="comPurchase"/>
        <result column="comPrice" property="comPrice"/>
        <result column="comRemarks" property="comRemarks"/>
        <result column="comMinKuNumber" property="comMinKuNumber"/>
        <result column="duo1" property="duo1"/>
        <result column="duo2" property="duo2"/>
        <result column="duo4" property="duo4"/>
        <result column="duo5" property="duo5"/>
        <!--2.商品表的生产厂商编号【comManufact】FK对应 生产厂商表的生产厂商编号【manId】PK-->
        <!-- <result column="comManufact" property="comManufact"/>-->
        <association property="manufacturer" resultMap="Manufacturer" >
        </association>

        <!--3.商品表的供货商编号【comSupplierNo】FK对应 供货商表的供货商编号【supID】PK -->
        <!--<result column="comSupplierNo" property="comSupplierNo"/>-->
        <association property="supplier" resultMap="supplier">
        </association>
    </resultMap>

    <!--生产厂商表Map-->
    <resultMap id="Manufacturer" type="manufacturer">
        <id column="manId" property="manId"/>
        <result column="manName" property="manName"/>
        <result column="manTelPhe" property="manTelPhe"/>
        <result column="manAddressNo" property="manAddressNo"/>
        <result column="manAddress" property="manAddress"/>
        <result column="manEmail" property="manEmail"/>
        <result column="manRemarks" property="manRemarks"/>
        <result column="duo1" property="duo1"/>
        <result column="duo2" property="duo2"/>
    </resultMap>

    <!--供货商表Map-->
    <resultMap id="supplier" type="supplier">
        <id column="supID" property="supID"/>
        <result column="supName" property="supName"/>
        <result column="supLinkman" property="supLinkman"/>
        <result column="supPhone" property="supPhone"/>
        <result column="supMoney" property="supMoney"/>
        <result column="supAddressNo" property="supAddressNo"/>
        <result column="supAddress" property="supAddress"/>
        <result column="supRegion" property="supRegion"/>
        <result column="supDefault" property="supDefault"/>
        <result column="supComment" property="supComment"/>
    </resultMap>

    <!--库存map-->
    <resultMap id="warehouseMap" type="warehouse">
        <id column="warID" property="warID"/>
        <result column="warName" property="warName"/>
        <result column="employeesNo" property="employeesNo"/>
        <result column="warPhone" property="warPhone"/>
        <result column="warAddressNo" property="warAddressNo"/>
        <result column="warAddress" property="warAddress"/>
        <result column="warDefault" property="warDefault"/>
        <result column="warForbidNo" property="warForbidNo"/>
        <result column="warComment" property="warComment"/>
        <result column="repNumber" property="repNumber"/>
        <result column="warTotalValue" property="warTotalValue"/>
        <result column="warCurrent" property="warCurrent"/>
        <result column="warLowest" property="warLowest"/>
        <result column="duo1" property="duo1"/>
        <result column="duo2" property="duo2"/>
        <result column="duo3" property="duo3"/>
    </resultMap>

</mapper>